
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Domain Model Implementation &mdash; Caravel-Transit 1.1 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Caravel-Transit 1.1 documentation" href="../index.html" />
    <link rel="up" title="Implementation" href="index.html" />
    <link rel="next" title="Web Implementation" href="web.html" />
    <link rel="prev" title="Database Implementation" href="database.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="web.html" title="Web Implementation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="database.html" title="Database Implementation"
             accesskey="P">previous</a> |</li>
        <li><a href="../caravel.html">Caravel-Transit 1.1 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Implementation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="domain-model-implementation">
<h1>Domain Model Implementation<a class="headerlink" href="#domain-model-implementation" title="Permalink to this headline">¶</a></h1>
<p>This section contains Sphinx &#8220;automodule&#8221; documentation from the various
components.</p>
<p>There are several tiers: <a class="reference internal" href="#extract-transform-load">Extract-Transform-Load</a> gathers data
and creates the <a class="reference internal" href="#current-status">Current Status</a>.  This is also used to support both
<a class="reference internal" href="#analysis-and-profiling">Analysis and Profiling</a> and <a class="reference internal" href="#applications">Applications</a>.</p>
<div class="section" id="extract-transform-load">
<h2>Extract-Transform-Load<a class="headerlink" href="#extract-transform-load" title="Permalink to this headline">¶</a></h2>
<p>There are several parts to the extract, transformation and load of
the vehicle reports and transit system data.</p>
<ol class="arabic simple">
<li>Mappings.</li>
<li>Real-Time Feed.</li>
<li>Validation and Creation of usable Tansit Status</li>
</ol>
<div class="section" id="module-caravel.LogCapture.acquire">
<span id="logcapture"></span><h3>LogCapture<a class="headerlink" href="#module-caravel.LogCapture.acquire" title="Permalink to this headline">¶</a></h3>
<p>Caravel FTP-based Data Acquisition</p>
<p>Gather raw position reports by polling an FTP server.</p>
<p>The position reports should be pushed into a queue for processing.
This can be a conceptual queue in a single-threaded applicaiton, or an
actual multi-processing queue to improve performance.</p>
<p>FTP Source</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">host</span><span class="o">=</span><span class="s">&#39;216.54.15.3&#39;</span>
<span class="n">user</span><span class="o">=</span><span class="s">&#39;anonymous&#39;</span>
<span class="n">passwd</span><span class="o">=</span><span class="s">&#39;slott56@gmail.com&#39;</span>
</pre></div>
</div>
<dl class="function">
<dt id="caravel.LogCapture.acquire.report_reader">
<tt class="descclassname">caravel.LogCapture.acquire.</tt><tt class="descname">report_reader</tt><big>(</big><em>connection=None</em>, <em>url=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/LogCapture/acquire.html#report_reader"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.LogCapture.acquire.report_reader" title="Permalink to this definition">¶</a></dt>
<dd><p>Open the position report file for reading.
This is a file-like object which must be closed properly.</p>
<div class="highlight-python"><pre>with closing( report_reader() ):
    for line in data:
        process line</pre>
</div>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>connection</strong> &#8211; Override to the default of urllib2</li>
<li><strong>host</strong> &#8211; URL for the real-time data.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.LogCapture.acquire.get_report_files">
<tt class="descclassname">caravel.LogCapture.acquire.</tt><tt class="descname">get_report_files</tt><big>(</big><em>connection=None</em>, <em>target_dir='.'</em>, <em>**access</em><big>)</big><a class="reference internal" href="../_modules/caravel/LogCapture/acquire.html#get_report_files"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.LogCapture.acquire.get_report_files" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the lastest position report &#8220;file&#8221; and save it to the
target directory.</p>
<p>Check for latest versions of &#8220;Anrd/vid.csv&#8221; and download it only if it changed.</p>
<p>Download the current version of  <tt class="docutils literal"><span class="pre">Anrd/hrtrtf.txt</span></tt> file;
naming it with a <tt class="docutils literal"><span class="pre">YYYYMMDDHHMM.rpt</span></tt> name.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>connection</strong> &#8211; Override to the default of ftplib.FTP</li>
<li><strong>target_dir</strong> &#8211; Working directory for result files</li>
<li><strong>host</strong> &#8211; IP address or name of the FTP host.</li>
<li><strong>user</strong> &#8211; FTP username</li>
<li><strong>passwd</strong> &#8211; FTP password</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<span class="target" id="module-caravel.LogCapture.capture"></span><p>Caravel Capture the Feed and Push into CouchDB.</p>
<p>Real-time feed CSV files are attached to a document with the following
attributes</p>
<div class="highlight-python"><pre>timestamp : year-mm-ddThh:mm:ssZ
status    : "new", "in-process", "transformed"
doc_type  : "Feed" -- used by couchdbkit.
The attached file must be named "feed"</pre>
</div>
<p>An example in JSON.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
   <span class="s">&quot;doc_type&quot;</span> <span class="p">:</span> <span class="s">&quot;Feed&quot;</span><span class="p">,</span>
   <span class="s">&quot;timestamp&quot;</span> <span class="p">:</span> <span class="s">&quot;yyyy-mm-ddThh:mm:ssZ&quot;</span><span class="p">,</span>
   <span class="s">&quot;status&quot;</span> <span class="p">:</span> <span class="s">&quot;new&quot;</span><span class="p">,</span>
   <span class="s">&quot;_attachments&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;feed&quot;</span> <span class="p">:</span> <span class="p">{</span>
         <span class="s">&quot;content-type&quot;</span> <span class="p">:</span> <span class="s">&quot;text/csv&quot;</span><span class="p">,</span>
         <span class="s">&quot;data&quot;</span> <span class="p">:</span> <span class="s">&quot;the,csv,data</span><span class="se">\n</span><span class="s">...&quot;</span><span class="p">,</span>
         <span class="p">},</span>
   <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With curl, it&#8217;s a sequence like the following.</p>
<p>Step 1 &#8211; POST.</p>
<div class="highlight-python"><pre>curl -X POST http://username:password@hrt.iriscouch.com:5984/couchdbkit_test/ --user &lt;user:password&gt; -H "Content-Type: application/json" -d '{"timestamp":"2012-03-02T16:16:00Z", "status":"new", "doc_type":"Feed"}'</pre>
</div>
<p>The response is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1af3&quot;</span><span class="p">,</span><span class="s">&quot;rev&quot;</span><span class="p">:</span><span class="s">&quot;1-7750ef2dbce77303f957de17c754852a&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Step 2 &#8211; PUT.</p>
<div class="highlight-python"><pre>curl -X PUT http://hrt.iriscouch.com:5984/couchdbkit_test/09833a88a1cbb06f64c555d0245f1af3/feed/?rev=1-7750ef2dbce77303f957de17c754852a --user &lt;user:password&gt; -H "Content-Type: text/csv" @201203022302.rpt</pre>
</div>
<p>The response is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1af3&quot;</span><span class="p">,</span><span class="s">&quot;rev&quot;</span><span class="p">:</span><span class="s">&quot;2-748151ff136b0001671fb0fa14eb886d&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Checking for new feeds is this</p>
<div class="highlight-python"><pre>curl http://hrt.iriscouch.com:5984/couchdbkit_test/_design/feed/_view/new</pre>
</div>
<p>Response is a JSON document like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;total_rows&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;offset&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;rows&quot;</span><span class="p">:[</span>
<span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1af3&quot;</span><span class="p">,</span><span class="s">&quot;key&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1af3&quot;</span><span class="p">,</span><span class="s">&quot;value&quot;</span><span class="p">:</span><span class="n">null</span><span class="p">},</span>
<span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1d98&quot;</span><span class="p">,</span><span class="s">&quot;key&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1d98&quot;</span><span class="p">,</span><span class="s">&quot;value&quot;</span><span class="p">:</span><span class="n">null</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>Individual documents are available:</p>
<div class="highlight-python"><pre>curl http://username:password@hrt.iriscouch.com:5984/couchdbkit_test/09833a88a1cbb06f64c555d0245f1af3/feed/</pre>
</div>
<span class="target" id="module-caravel.LogCapture.couch_push"></span><p>Caravel Push a Mapping.</p>
<p>Push Mapping data to HRT CouchDB.</p>
<p>A mapping file must be CSV format (with well-defined headings.
They are attached to a document with the following
attributes</p>
<div class="highlight-python"><pre>timestamp      : year-mm-ddThh:mm:ssZ
effective_date : year-mm-dd
mapping_type   : vehicle, route or stop
doc_type       : "Mapping" -- used by couchdbkit.
content        : the file</pre>
</div>
<p>Example JSON document</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
   <span class="s">&quot;doc_type&quot;</span> <span class="p">:</span> <span class="s">&quot;Mapping&quot;</span><span class="p">,</span>
   <span class="s">&quot;timestamp&quot;</span> <span class="p">:</span> <span class="s">&quot;yyyy-mm-ddThh:mm:ssZ&quot;</span><span class="p">,</span>
   <span class="s">&quot;effective_date&quot;</span> <span class="p">:</span> <span class="s">&quot;yyyy-mm-dd&quot;</span><span class="p">,</span>
   <span class="s">&quot;mapping_type&quot;</span> <span class="p">:</span> <span class="s">&quot;vehicle&quot;</span><span class="p">,</span>
   <span class="s">&quot;status&quot;</span> <span class="p">:</span> <span class="s">&quot;new&quot;</span><span class="p">,</span>
   <span class="s">&quot;_attachments&quot;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s">&quot;content&quot;</span> <span class="p">:</span> <span class="p">{</span>
         <span class="s">&quot;content-type&quot;</span> <span class="p">:</span> <span class="s">&quot;text/csv&quot;</span><span class="p">,</span>
         <span class="s">&quot;data&quot;</span> <span class="p">:</span> <span class="s">&quot;the,csv,data</span><span class="se">\n</span><span class="s">...&quot;</span><span class="p">,</span>
         <span class="p">},</span>
   <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With curl, it&#8217;s a sequence like the following</p>
<div class="highlight-python"><pre>curl -X POST http://username:password@hrt.iriscouch.com:5984/couchdbkit_test/
--user &lt;user:password&gt;
-H "Content-Type: application/json"
-d '{"timestamp":"2012-03-02T16:16:00Z", "mapping_type":"vehicle", "effective_date": "2012-03-03", "doc_type":"Mapping"}'</pre>
</div>
<p>The response is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1af3&quot;</span><span class="p">,</span><span class="s">&quot;rev&quot;</span><span class="p">:</span><span class="s">&quot;1-7750ef2dbce77303f957de17c754852a&quot;</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python"><pre>curl -X PUT http://hrt.iriscouch.com:5984/couchdbkit_test/09833a88a1cbb06f64c555d0245f1af3/content/?rev=1-7750ef2dbce77303f957de17c754852a
--user &lt;user:password&gt;
-H "Content-Type: text/csv" @new_vehicle_mapping.csv</pre>
</div>
<p>The response is:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;ok&quot;</span><span class="p">:</span><span class="n">true</span><span class="p">,</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1af3&quot;</span><span class="p">,</span><span class="s">&quot;rev&quot;</span><span class="p">:</span><span class="s">&quot;2-748151ff136b0001671fb0fa14eb886d&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Checking for new feeds is this</p>
<div class="highlight-python"><pre>curl http://hrt.iriscouch.com:5984/couchdbkit_test/_design/mapping/_view/new</pre>
</div>
<p>Response is a JSON document like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span><span class="s">&quot;total_rows&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;offset&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s">&quot;rows&quot;</span><span class="p">:[</span>
<span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1af3&quot;</span><span class="p">,</span><span class="s">&quot;key&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1af3&quot;</span><span class="p">,</span><span class="s">&quot;value&quot;</span><span class="p">:</span><span class="n">null</span><span class="p">},</span>
<span class="p">{</span><span class="s">&quot;id&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1d98&quot;</span><span class="p">,</span><span class="s">&quot;key&quot;</span><span class="p">:</span><span class="s">&quot;09833a88a1cbb06f64c555d0245f1d98&quot;</span><span class="p">,</span><span class="s">&quot;value&quot;</span><span class="p">:</span><span class="n">null</span><span class="p">}</span>
<span class="p">]}</span>
</pre></div>
</div>
<p>Individual documents are available:</p>
<div class="highlight-python"><pre>curl http://username:password@hrt.iriscouch.com:5984/couchdbkit_test/09833a88a1cbb06f64c555d0245f1af3/content/</pre>
</div>
</div>
<div class="section" id="module-caravel.feed">
<span id="feed"></span><h3>Feed<a class="headerlink" href="#module-caravel.feed" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="module-caravel.report">
<span id="report"></span><h3>Report<a class="headerlink" href="#module-caravel.report" title="Permalink to this headline">¶</a></h3>
<p>Caravel Report object definitions.</p>
<p>This reads one (or more) raw files (or file-like CouchDB Attachments)
and creates a sequence of Report instances.  The subclasses include</p>
<ul class="simple">
<li>Location - a simple location report; rte is None and dwell is None.</li>
<li>Dwell - a Report with route/direction/stop and dwell time;
rte is not None and dwell is not None.</li>
<li>Arrival - a Report with route/direction/stop arrived instead of dwell time
rte is not None and dwell is None.</li>
</ul>
<p>The fourth possible combination (rte is None and dwell is not None) cannot occur.</p>
<div class="section" id="report-objects">
<h4>Report Objects<a class="headerlink" href="#report-objects" title="Permalink to this headline">¶</a></h4>
<dl class="class">
<dt id="caravel.report.Report">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">Report</tt><big>(</big><em>_d=None</em>, <em>**kwargs</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#Report"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.Report" title="Permalink to this definition">¶</a></dt>
<dd><p>Abstract superclass of the various kinds of reports.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.report.Location">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">Location</tt><big>(</big><em>_d=None</em>, <em>**kwargs</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#Location"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.Location" title="Permalink to this definition">¶</a></dt>
<dd><p>A Location report for a Vehicle in motion.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.report.Arrival">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">Arrival</tt><big>(</big><em>_d=None</em>, <em>**kwargs</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#Arrival"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.Arrival" title="Permalink to this definition">¶</a></dt>
<dd><p>A Location report for a Vehicle arriving at a stop.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.report.Dwell">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">Dwell</tt><big>(</big><em>_d=None</em>, <em>**kwargs</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#Dwell"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.Dwell" title="Permalink to this definition">¶</a></dt>
<dd><p>A Location report for a Vehicle paused at a stop.
This is less helpful and may get filtered out.</p>
</dd></dl>

</div>
<div class="section" id="report-factory">
<h4>Report Factory<a class="headerlink" href="#report-factory" title="Permalink to this headline">¶</a></h4>
<dl class="class">
<dt id="caravel.report.ReportReader">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">ReportReader</tt><big>(</big><em>year=None</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader" title="Permalink to this definition">¶</a></dt>
<dd><p>An abstract iterator over Report items (<a class="reference internal" href="#caravel.report.Location" title="caravel.report.Location"><tt class="xref py py-class docutils literal"><span class="pre">Location</span></tt></a>, <a class="reference internal" href="#caravel.report.Arrival" title="caravel.report.Arrival"><tt class="xref py py-class docutils literal"><span class="pre">Arrival</span></tt></a>, <a class="reference internal" href="#caravel.report.Dwell" title="caravel.report.Dwell"><tt class="xref py py-class docutils literal"><span class="pre">Dwell</span></tt></a>).</p>
<p>This is the abstract superclass for various reader implementations.</p>
<p>Requires <a class="reference internal" href="#caravel.report.ReportReader.open" title="caravel.report.ReportReader.open"><tt class="xref py py-meth docutils literal"><span class="pre">ReportReader.open()</span></tt></a>
and <a class="reference internal" href="#caravel.report.ReportReader.factory" title="caravel.report.ReportReader.factory"><tt class="xref py py-meth docutils literal"><span class="pre">ReportReader.factory()</span></tt></a>.</p>
<dl class="method">
<dt id="caravel.report.ReportReader.__init__">
<tt class="descname">__init__</tt><big>(</big><em>year=None</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader.__init__" title="Permalink to this definition">¶</a></dt>
<dd><p>Build a ReportReader_v1 with a given default year.</p>
<p>The year is required because the timestamps only have month and day.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>year</strong> &#8211; Year extracted from file name.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader.__iter__">
<tt class="descname">__iter__</tt><big>(</big><big>)</big><a class="headerlink" href="#caravel.report.ReportReader.__iter__" title="Permalink to this definition">¶</a></dt>
<dd><p>Iterate over Report instances in this source.</p>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader.factory">
<tt class="descname">factory</tt><big>(</big><em>line</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader.factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the fields, returning Arrival, Dwell or Location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>line</strong> &#8211; line of raw input.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Report instance, if possible.  <tt class="docutils literal"><span class="pre">None</span></tt> if the fields can&#8217;t be parsed.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader.open">
<tt class="descname">open</tt><big>(</big><em>source</em>, <em>year=None</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a given source for processing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>source</strong> &#8211; an open file-like source.</li>
<li><strong>year</strong> &#8211; a potential override for the default year.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.report.ReportReader_v1">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">ReportReader_v1</tt><big>(</big><em>year=None</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v1" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterator over Report items (<a class="reference internal" href="#caravel.report.Location" title="caravel.report.Location"><tt class="xref py py-class docutils literal"><span class="pre">Location</span></tt></a>, <a class="reference internal" href="#caravel.report.Arrival" title="caravel.report.Arrival"><tt class="xref py py-class docutils literal"><span class="pre">Arrival</span></tt></a>, <a class="reference internal" href="#caravel.report.Dwell" title="caravel.report.Dwell"><tt class="xref py py-class docutils literal"><span class="pre">Dwell</span></tt></a>).</p>
<p>This handles V1 format, with space-delimited fields in the following form.</p>
<div class="highlight-python"><pre>07:04:42 02/15  V.1.2233  H.0.0  MT_LOCATION    Lat/Lon:370620935/-763413842 [Valid]  Adher:-1 [Valid]  Odom:2668 [Valid]  DGPS:On  FOM:2</pre>
</div>
<p>This is an iterable object, generally something like the following is done:</p>
<div class="highlight-python"><pre>reader= ReportReader_v1()
with open(some_file) as source:
    reader.open(some_file)
    for report in reader:
        # process report</pre>
</div>
<dl class="method">
<dt id="caravel.report.ReportReader_v1.common_fields">
<tt class="descname">common_fields</tt><big>(</big><em>fields</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v1.common_fields" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the common set of fields.
These are Fields 13-20 of MT_TIMEPOINTCROSSING.
They are also Fields 5-12 of MT_LOCATION.</p>
<p>These fields are</p>
<ul class="simple">
<li>&#8220;Lat/Lon&#8221; and the following &#8220;[Valid]&#8221;/&#8221;[Invalid]&#8221; flag.</li>
<li>&#8220;Adher&#8221; and the following &#8220;[Valid]&#8221;/&#8221;[Invalid]&#8221; flag.</li>
<li>&#8220;Odom&#8221; and the following &#8220;[Valid]&#8221;/&#8221;[Invalid]&#8221; flag.</li>
<li>&#8220;DGPS&#8221;</li>
<li>&#8220;FOM&#8221;</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">tuple of (lat, lon, ll_valid, adher, adher_valid, odom, odom_valid, dgps, fom)</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.factory">
<tt class="descname">factory</tt><big>(</big><em>line</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v1.factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the fields, returning Arrival, Dwell or Location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>line</strong> &#8211; line of raw input.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Report instance, if possible.  <tt class="docutils literal"><span class="pre">None</span></tt> if the fields can&#8217;t be parsed.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.label_int">
<tt class="descname">label_int</tt><big>(</big><em>field</em>, <em>expected</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v1.label_int" title="Permalink to this definition">¶</a></dt>
<dd><p>Split a &#8220;label:value&#8221; field, attempting an integer conversion.
If the label is not as expected, raise an exception.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>field</strong> &#8211; a &#8220;label:value field</li>
<li><strong>expected</strong> &#8211; the expected label.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">the integer value</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.label_lat_lon">
<tt class="descname">label_lat_lon</tt><big>(</big><em>field</em>, <em>expected='Lat/Lon'</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v1.label_lat_lon" title="Permalink to this definition">¶</a></dt>
<dd><p>Split a &#8220;label:lat/lon&#8221; field, attempting an fairly complex conversion.
If the label is not as expected, raise an exception.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>field</strong> &#8211; a &#8220;label:lat/lon field</li>
<li><strong>expected</strong> &#8211; the expected label.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">(lat, lon) 2-tuple</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.label_str">
<tt class="descname">label_str</tt><big>(</big><em>field</em>, <em>expected</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v1.label_str" title="Permalink to this definition">¶</a></dt>
<dd><p>Split a &#8220;label:value&#8221; field, doing no further conversion.
If the label is not as expected, raise an exception.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>field</strong> &#8211; a &#8220;label:value field</li>
<li><strong>expected</strong> &#8211; the expected label.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">the string value</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.label_time">
<tt class="descname">label_time</tt><big>(</big><em>field</em>, <em>expected</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v1.label_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Split a &#8220;label:time&#8221; field, to create a seconds-after-midnight value.
If the label is not as expected, raise an exception.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>field</strong> &#8211; a &#8220;label:time field</li>
<li><strong>expected</strong> &#8211; the expected label.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">datetime.time() object.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.open">
<tt class="descname">open</tt><big>(</big><em>source</em>, <em>year=None</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v1.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a given source for processing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>source</strong> &#8211; an open file-like source.</li>
<li><strong>year</strong> &#8211; a potential override for the default year.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="attribute">
<dt id="caravel.report.ReportReader_v1.vehicle_pat">
<tt class="descname">vehicle_pat</tt><em class="property"> = &lt;_sre.SRE_Pattern object at 0x1045402f0&gt;</em><a class="headerlink" href="#caravel.report.ReportReader_v1.vehicle_pat" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.report.ReportReader_v21">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">ReportReader_v21</tt><big>(</big><em>year=None</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v21" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterator over Report items (<a class="reference internal" href="#caravel.report.Location" title="caravel.report.Location"><tt class="xref py py-class docutils literal"><span class="pre">Location</span></tt></a>, <a class="reference internal" href="#caravel.report.Arrival" title="caravel.report.Arrival"><tt class="xref py py-class docutils literal"><span class="pre">Arrival</span></tt></a>, <a class="reference internal" href="#caravel.report.Dwell" title="caravel.report.Dwell"><tt class="xref py py-class docutils literal"><span class="pre">Dwell</span></tt></a>).</p>
<p>This handles V2.1 format, which is CSV and includes Route ID.</p>
<p>First Line:</p>
<div class="highlight-python"><pre>Time,Date,RID,Lat/Lon,Location Valid/Invalid,Adherence,Adherence Valid/Invalid[,Route,Direction,StopID]</pre>
</div>
<p>Column Titles:</p>
<blockquote>
<div><ul class="simple">
<li>&#8216;Time&#8217;</li>
<li>&#8216;Date&#8217;</li>
<li>&#8216;RID&#8217;</li>
<li>&#8216;Lat/Lon&#8217;</li>
<li>&#8216;Location Valid/Invalid&#8217;</li>
<li>&#8216;Adherence&#8217;</li>
<li>&#8216;Adherence Valid/Invalid[&#8216; # Really.</li>
<li>&#8216;Route&#8217;</li>
<li>&#8216;Direction&#8217;</li>
<li>&#8216;StopID]&#8217; # Also peculiar.</li>
</ul>
</div></blockquote>
<p>This is an iterable object, generally something like the following is done:</p>
<div class="highlight-python"><pre>reader= ReportReader_v2()
with open(some_file) as source:
    reader.open(some_file)
    for report in reader:
        # process report</pre>
</div>
<dl class="method">
<dt id="caravel.report.ReportReader_v21.factory">
<tt class="descname">factory</tt><big>(</big><em>line</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v21.factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the fields, returning Arrival, Dwell or Location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>line</strong> &#8211; CSV line of raw input.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Report instance, if possible.  <tt class="docutils literal"><span class="pre">None</span></tt> if the fields can&#8217;t be parsed.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v21.open">
<tt class="descname">open</tt><big>(</big><em>source</em>, <em>year=None</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v21.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a given source for processing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>source</strong> &#8211; an open file-like source.</li>
<li><strong>year</strong> &#8211; a potential override for the default year.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.report.ReportReader_v22">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">ReportReader_v22</tt><big>(</big><em>year=None</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v22" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterator over Report items (<a class="reference internal" href="#caravel.report.Location" title="caravel.report.Location"><tt class="xref py py-class docutils literal"><span class="pre">Location</span></tt></a>, <a class="reference internal" href="#caravel.report.Arrival" title="caravel.report.Arrival"><tt class="xref py py-class docutils literal"><span class="pre">Arrival</span></tt></a>, <a class="reference internal" href="#caravel.report.Dwell" title="caravel.report.Dwell"><tt class="xref py py-class docutils literal"><span class="pre">Dwell</span></tt></a>).</p>
<p>This handles V2.2 format, which is CSV and includes Vehicle ID</p>
<p>First Line:</p>
<div class="highlight-python"><pre>Time,Date,Vehicle,Lat/Lon,Location Valid/Invalid,Adherence,Adherence Valid/Invalid[,Route,Direction,StopID]</pre>
</div>
<p>Column Titles:</p>
<blockquote>
<div><ul class="simple">
<li>&#8216;Time&#8217;</li>
<li>&#8216;Date&#8217;</li>
<li>&#8216;Vehicle&#8217;</li>
<li>&#8216;Lat/Lon&#8217;</li>
<li>&#8216;Location Valid/Invalid&#8217;</li>
<li>&#8216;Adherence&#8217;</li>
<li>&#8216;Adherence Valid/Invalid[&#8216; # Really.</li>
<li>&#8216;Route&#8217;</li>
<li>&#8216;Direction&#8217;</li>
<li>&#8216;Stop]&#8217; # Also peculiar.</li>
</ul>
</div></blockquote>
<p>This is an iterable object, generally something like the following is done:</p>
<div class="highlight-python"><pre>reader= ReportReader_v3()
with open(some_file) as source:
    reader.open(some_file)
    for report in reader:
        # process report</pre>
</div>
<dl class="method">
<dt id="caravel.report.ReportReader_v22.factory">
<tt class="descname">factory</tt><big>(</big><em>line</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v22.factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the fields, returning Arrival, Dwell or Location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>line</strong> &#8211; CSV line of raw input.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Report instance, if possible.  <tt class="docutils literal"><span class="pre">None</span></tt> if the fields can&#8217;t be parsed.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.report.ReportReader_v3">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">ReportReader_v3</tt><big>(</big><em>year=None</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v3" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterator over Report items (<a class="reference internal" href="#caravel.report.Location" title="caravel.report.Location"><tt class="xref py py-class docutils literal"><span class="pre">Location</span></tt></a>, <a class="reference internal" href="#caravel.report.Arrival" title="caravel.report.Arrival"><tt class="xref py py-class docutils literal"><span class="pre">Arrival</span></tt></a>, <a class="reference internal" href="#caravel.report.Dwell" title="caravel.report.Dwell"><tt class="xref py py-class docutils literal"><span class="pre">Dwell</span></tt></a>).</p>
<p>This handles V3 format, which is CSV.</p>
<p>Source:</p>
<div class="highlight-python"><pre>String[] headings = {
    "Date", "Time", "Vehicle", "Lat", "Lon", "Location Valid/Invalid",
    "Adherence", "Adherence Valid/Invalid", "Route", "Direction", "Stop"
};</pre>
</div>
<p>Column Titles:</p>
<blockquote>
<div><ul class="simple">
<li>&#8216;Date&#8217;</li>
<li>&#8216;Time&#8217;</li>
<li>&#8216;Vehicle&#8217;</li>
<li>&#8216;Lat&#8217;</li>
<li>&#8216;Lon&#8217;</li>
<li>&#8216;Location Valid/Invalid&#8217;</li>
<li>&#8216;Adherence&#8217;</li>
<li>&#8216;Adherence Valid/Invalid&#8217;</li>
<li>&#8216;Route&#8217;</li>
<li>&#8216;Direction&#8217;</li>
<li>&#8216;Stop&#8217;</li>
</ul>
</div></blockquote>
<p>This is an iterable object, generally something like the following is done:</p>
<div class="highlight-python"><pre>reader= ReportReader_v3()
with open(some_file) as source:
    reader.open(some_file)
    for report in reader:
        # process report</pre>
</div>
<dl class="method">
<dt id="caravel.report.ReportReader_v3.factory">
<tt class="descname">factory</tt><big>(</big><em>line</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v3.factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the fields, returning Arrival, Dwell or Location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>line</strong> &#8211; CSV line of raw input.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Report instance, if possible.  <tt class="docutils literal"><span class="pre">None</span></tt> if the fields can&#8217;t be parsed.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v3.open">
<tt class="descname">open</tt><big>(</big><em>source</em><big>)</big><a class="headerlink" href="#caravel.report.ReportReader_v3.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a given source for processing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>source</strong> &#8211; an open file-like source.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="caravel.report.report_file_iter">
<tt class="descclassname">caravel.report.</tt><tt class="descname">report_file_iter</tt><big>(</big><em>report_reader</em>, <em>files</em><big>)</big><a class="headerlink" href="#caravel.report.report_file_iter" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterator which applies the <tt class="docutils literal"><span class="pre">report_reader</span></tt> instance to all
of the named files.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>report_reader</strong> &#8211; an instance of <a class="reference internal" href="#caravel.report.ReportReader" title="caravel.report.ReportReader"><tt class="xref py py-class docutils literal"><span class="pre">ReportReader</span></tt></a> which parses
input lines and creates <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">Report</span></tt></a> instances.</li>
<li><strong>files</strong> &#8211; an iterable over the file names.
To process a single file, use <tt class="docutils literal"><span class="pre">report_file_iter(</span> <span class="pre">report_reader,</span> <span class="pre">[one_file]</span> <span class="pre">)</span></tt></li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="json-codec">
<h4>JSON Codec<a class="headerlink" href="#json-codec" title="Permalink to this headline">¶</a></h4>
<p>This is not terribly useful, since CouchDB does this for us.</p>
<dl class="class">
<dt id="caravel.report.JSONEncoder">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">JSONEncoder</tt><big>(</big><em>skipkeys=False</em>, <em>ensure_ascii=True</em>, <em>check_circular=True</em>, <em>allow_nan=True</em>, <em>sort_keys=False</em>, <em>indent=None</em>, <em>separators=None</em>, <em>encoding='utf-8'</em>, <em>default=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#JSONEncoder"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.JSONEncoder" title="Permalink to this definition">¶</a></dt>
<dd><p>Encode any of the Report subclasses into JSON.</p>
<p>Not needed, since couchdbkit.schema.Document objects
have a <tt class="xref py py-meth docutils literal"><span class="pre">couchdbkit.schema.Document.to_json()</span></tt> method that
handles some of the conversion.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="n">rpt</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span> <span class="p">)</span>
</pre></div>
</div>
<p>Far better than this.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.report.JSONDecoder">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">JSONDecoder</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#JSONDecoder"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.JSONDecoder" title="Permalink to this definition">¶</a></dt>
<dd><p>Decode any of the Report subclasses from JSON.</p>
</dd></dl>

</div>
</div>
<div class="section" id="module-caravel.admin">
<span id="administrative-functions"></span><h3>Administrative Functions<a class="headerlink" href="#module-caravel.admin" title="Permalink to this headline">¶</a></h3>
<p>Caravel CouchDB Admin Functions.</p>
<p>This will create databases, create applications.</p>
<p>It will also do things like clean the feed database.</p>
<span class="target" id="module-caravel.settings"></span><p>Caravel Couch DB settings</p>
</div>
</div>
<div class="section" id="current-status">
<h2>Current Status<a class="headerlink" href="#current-status" title="Permalink to this headline">¶</a></h2>
<div class="section" id="status-builder">
<h3>Status Builder<a class="headerlink" href="#status-builder" title="Permalink to this headline">¶</a></h3>
<p>This actually include mapping validation, feed validation
as well as feed transform and load to create transit system
status.</p>
<span class="target" id="module-caravel.StatusBuilder.bulk_transform"></span><p>Caravel processing of raw feed and mapping into route, stop and vehicle status
reports.</p>
<p>This is a one-time manual operation that can be driven via cron.</p>
<ol class="arabic simple">
<li>Handle new mappings.  Validate.  Update Cache.  Cleanup.
See <a class="reference internal" href="#module-caravel.feed.mapping_load" title="caravel.feed.mapping_load"><tt class="xref py py-mod docutils literal"><span class="pre">caravel.feed.mapping_load</span></tt></a>.</li>
<li>Handle new feeds.  Validate.  Apply Mappings.  Cleanup.
See <a class="reference internal" href="#module-caravel.feed.feed_load" title="caravel.feed.feed_load"><tt class="xref py py-mod docutils literal"><span class="pre">caravel.feed.feed_load</span></tt></a>.</li>
<li>Build status.  See <a class="reference internal" href="#module-caravel.status.status_load" title="caravel.status.status_load"><tt class="xref py py-mod docutils literal"><span class="pre">caravel.status.status_load</span></tt></a>.</li>
</ol>
<span class="target" id="module-caravel.StatusBuilder.change_notification"></span><p>Caravel processing of raw feed and mapping into route, stop and vehicle status
reports.</p>
<p>This relies on Couchdb Change Notification via long polling.</p>
<ol class="arabic simple">
<li>Handle new mappings.  Validate.  Update Cache.  Cleanup.
See <a class="reference internal" href="#module-caravel.feed.mapping_load" title="caravel.feed.mapping_load"><tt class="xref py py-mod docutils literal"><span class="pre">caravel.feed.mapping_load</span></tt></a>.</li>
<li>Handle new feeds.  Validate.  Apply Mappings.  Cleanup.
See <a class="reference internal" href="#module-caravel.feed.feed_load" title="caravel.feed.feed_load"><tt class="xref py py-mod docutils literal"><span class="pre">caravel.feed.feed_load</span></tt></a>.</li>
<li>Build status.  See <a class="reference internal" href="#module-caravel.status.status_load" title="caravel.status.status_load"><tt class="xref py py-mod docutils literal"><span class="pre">caravel.status.status_load</span></tt></a>.</li>
</ol>
<div class="section" id="overall-control">
<h4>Overall Control<a class="headerlink" href="#overall-control" title="Permalink to this headline">¶</a></h4>
<p>The overall control is driven by tracking status changes that are emitted
by the couchdb.  The change notification long polling technique provides
a sequence of change documents.</p>
<p>For documents which are mappings, this triggers the mapping
validation, and cache update.</p>
<p>For documents which are feeds, this triggers feed validation, and status
updates.</p>
<p>The cleanup cycles can triggered asynchronously based on</p>
<ul class="simple">
<li>cron in a separate process.</li>
<li>heartbeat from couchdb.</li>
<li>watching the clock during ordinary processing cycles (i.e.,
intermittently after feed processing is completed.).</li>
</ul>
</div>
<div class="section" id="recursion-detection">
<h4>Recursion Detection<a class="headerlink" href="#recursion-detection" title="Permalink to this headline">¶</a></h4>
<p>Once we start processing a feed or mapping, we&#8217;ll get renotified of the
changes we&#8217;re making to that mapping.</p>
<p>To prevent infinite recursion, we keep a small FIFO of documents that we
ignore when the appear a second time.  After all, this process does
numerous updates, so it gets notified of the updates it made.</p>
</div>
</div>
<div class="section" id="id1">
<h3>Feed<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<span class="target" id="module-caravel.feed.models"></span><p>HRT Couch DB LogCapture Feed Models.</p>
<p>This describes the data pushed by LogCapture.</p>
<span class="target" id="module-caravel.feed.mapping_load"></span><p>Caravel ETL of real-time-feed with mappings
from source encodings to GTFS keys.</p>
<div class="section" id="load-new-mappings">
<h4>Load New Mappings<a class="headerlink" href="#load-new-mappings" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Get any new mapping.</li>
<li>Validate the mapping.<ul>
<li>Check the timestamp and delete duplicates (same type,
same effective date, same or older timestamp).</li>
<li>Check the type.</li>
<li>Check the attachment size and structure.</li>
</ul>
</li>
<li>Put in a proper effective date range.</li>
<li>Cache the current mapping chosen from the set of valid mappings.
It&#8217;s helpful to keep this in memory to save time.</li>
</ol>
</div>
<div class="section" id="components">
<h4>Components<a class="headerlink" href="#components" title="Permalink to this headline">¶</a></h4>
<div class="section" id="attachment-handling">
<h5>Attachment Handling<a class="headerlink" href="#attachment-handling" title="Permalink to this headline">¶</a></h5>
<dl class="class">
<dt id="caravel.feed.mapping_load.Invalid_Mapping">
<em class="property">class </em><tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">Invalid_Mapping</tt><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#Invalid_Mapping"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.Invalid_Mapping" title="Permalink to this definition">¶</a></dt>
<dd><p>An exception raised as part of mapping validation.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.feed.mapping_load.CSV_Attachment">
<em class="property">class </em><tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">CSV_Attachment</tt><big>(</big><em>document</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#CSV_Attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.CSV_Attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>The attached file for a mapping.  The file should be a .CSV notation
file with two specific column names.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.feed.mapping_load.Vehicle_Attachment">
<em class="property">class </em><tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">Vehicle_Attachment</tt><big>(</big><em>document</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#Vehicle_Attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.Vehicle_Attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="#caravel.feed.mapping_load.CSV_Attachment" title="caravel.feed.mapping_load.CSV_Attachment"><tt class="xref py py-class docutils literal"><span class="pre">CSV_Attachment</span></tt></a> for the vehicle mapping.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.feed.mapping_load.Route_Attachment">
<em class="property">class </em><tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">Route_Attachment</tt><big>(</big><em>document</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#Route_Attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.Route_Attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="#caravel.feed.mapping_load.CSV_Attachment" title="caravel.feed.mapping_load.CSV_Attachment"><tt class="xref py py-class docutils literal"><span class="pre">CSV_Attachment</span></tt></a> for the route mapping.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.feed.mapping_load.Stop_Attachment">
<em class="property">class </em><tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">Stop_Attachment</tt><big>(</big><em>document</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#Stop_Attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.Stop_Attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="#caravel.feed.mapping_load.CSV_Attachment" title="caravel.feed.mapping_load.CSV_Attachment"><tt class="xref py py-class docutils literal"><span class="pre">CSV_Attachment</span></tt></a> for the stop id mapping.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.mapping_load.mapping_attachment">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">mapping_attachment</tt><big>(</big><em>mapping</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#mapping_attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.mapping_attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>Instantiate the proper CSV_Attachment subclass
for this mapping.</p>
</dd></dl>

</div>
<div class="section" id="mapping-processing">
<h5>Mapping Processing<a class="headerlink" href="#mapping-processing" title="Permalink to this headline">¶</a></h5>
<dl class="function">
<dt id="caravel.feed.mapping_load.validate">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">validate</tt><big>(</big><em>mapping</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#validate"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.validate" title="Permalink to this definition">¶</a></dt>
<dd><p>Validate a given mapping object.  This will locate
an appropriate attachment handler and then invoke the attachment
handler&#8217;s <tt class="xref py py-meth docutils literal"><span class="pre">CSV_Attachment.validate()</span></tt> method.</p>
<p>This is the first step when processing a new mapping.</p>
<p>If anything goes wrong an exception is raised.
Otherwise this returns the mapping.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.mapping_load.validate_new">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">validate_new</tt><big>(</big><em>mapping_iter</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#validate_new"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.validate_new" title="Permalink to this definition">¶</a></dt>
<dd><p>For all new mappings, validate the attached content and update
the status to mark them as usable.</p>
<p>Return a dictionary of sequences of the new mappings which are also valid.
The keys are the mapping types.  The value is a sequence of valid
mappings of that type.
This return value signals that we must rework the timeline
and reload the mappings that are in cache.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.mapping_load.assemble_timeline">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">assemble_timeline</tt><big>(</big><em>mapping_type</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#assemble_timeline"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.assemble_timeline" title="Permalink to this definition">¶</a></dt>
<dd><p>For all valid mappings, reassemble the timeline for each type.</p>
<p>This is the sequence of valid mappings in order by their
effective_date from most recent to oldest.</p>
<p>The most recent applies until the end of time.
Each previous mapping applies until the one more recently added.
Generally, just the last two mappings need to be tweaked to have
proper ending dates.  As a simplification, we reset all
ending dates to assure consistent data.</p>
<p>Returns the sequence of mappings of the given type.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.mapping_load.fetch_current">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">fetch_current</tt><big>(</big><em>mapping_type</em>, <em>today</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#fetch_current"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.fetch_current" title="Permalink to this definition">¶</a></dt>
<dd><p>Locate the mapping of the given type which is active today.
This requires that mappings are all validated and the timeline
has been assembled correctly.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.mapping_load.refresh_mapping_cache">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">refresh_mapping_cache</tt><big>(</big><em>mapping_cache</em>, <em>new_mappings=None</em>, <em>today=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#refresh_mapping_cache"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.refresh_mapping_cache" title="Permalink to this definition">¶</a></dt>
<dd><p>Locate the current mappings so they can be cached and used.</p>
<ol class="arabic simple">
<li>Validate all new mappings.
This uses <a class="reference internal" href="#caravel.feed.mapping_load.validate_new" title="caravel.feed.mapping_load.validate_new"><tt class="xref py py-func docutils literal"><span class="pre">validate_new()</span></tt></a>.</li>
<li>Among the valid maps, reason out the timeline and make
sure the effective_dates and ending_dates all make sense.
This uses <a class="reference internal" href="#caravel.feed.mapping_load.assemble_timeline" title="caravel.feed.mapping_load.assemble_timeline"><tt class="xref py py-func docutils literal"><span class="pre">assemble_timeline()</span></tt></a>.</li>
<li>Pick the mappings that apply today.
This uses <a class="reference internal" href="#caravel.feed.mapping_load.fetch_current" title="caravel.feed.mapping_load.fetch_current"><tt class="xref py py-func docutils literal"><span class="pre">fetch_current()</span></tt></a>.</li>
<li>Compare with the mappings in the local mappings cache.
If the current mapping is new, then parse the CSV mapping data.
If the current mapping hasn&#8217;t changed, then we&#8217;re good.</li>
</ol>
<p>This must be run based on two events.</p>
<ul class="simple">
<li>Beginning of each day.</li>
<li>Each time a mapping is pushed.</li>
</ul>
<p>It can be run before each feed is processed, but that&#8217;s a bit more
processing than is strictly necessary.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">dictionary with &#8216;vehicle&#8217;, &#8216;route&#8217;, &#8216;stop&#8217; mappings.</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
<span class="target" id="module-caravel.feed.feed_load"></span><p>Caravel ETL of real-time-feed with mappings
from source encodings to GTFS keys.</p>
<div class="section" id="load-new-feeds">
<h4>Load New Feeds<a class="headerlink" href="#load-new-feeds" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Get the next unprocessed feed.</p>
<ul class="simple">
<li>Discard unreadable feeds.</li>
<li>Discard feeds with improper headings.</li>
</ul>
</li>
<li><p class="first">Apply the mapping;
create the sequence of position reports.
It&#8217;s not essential to persist the position reports.</p>
<p>The LogTail application uses the following headings for a feed.</p>
<div class="highlight-python"><pre>String[] headings = {
    "Date", "Time", "Vehicle", "Lat", "Lon", "Location Valid/Invalid",
    "Adherence", "Adherence Valid/Invalid", "Route", "Direction", "Stop"
};</pre>
</div>
</li>
<li><p class="first">Clean up old feeds.</p>
</li>
</ol>
</div>
<div class="section" id="id2">
<h4>Components<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="caravel.feed.feed_load.remove_damaged">
<tt class="descclassname">caravel.feed.feed_load.</tt><tt class="descname">remove_damaged</tt><big>(</big><em>db</em>, <em>feed_iter</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/feed_load.html#remove_damaged"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.feed_load.remove_damaged" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove feed documents which are so damaged we can&#8217;t map them
to Python objects.</p>
<p>This is rare, and usually comes from poor unit testing on LogTail.</p>
<p>Once in a while, something can go horribly wrong and the
query needs to be changed to &#8220;feed/all&#8221; to check all feeds
instead of &#8220;feed/new&#8221;.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.feed_load.remove_old">
<tt class="descclassname">caravel.feed.feed_load.</tt><tt class="descname">remove_old</tt><big>(</big><em>db</em>, <em>today=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/feed_load.html#remove_old"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.feed_load.remove_old" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="function">
<dt id="caravel.feed.feed_load.new_feed_iter">
<tt class="descclassname">caravel.feed.feed_load.</tt><tt class="descname">new_feed_iter</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/caravel/feed/feed_load.html#new_feed_iter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.feed_load.new_feed_iter" title="Permalink to this definition">¶</a></dt>
<dd><p>Query all real-time Feed uploads.
Do a validation to assure that</p>
<ol class="loweralpha simple">
<li>we can build a Feed object,</li>
<li>there&#8217;s a proper attachment.</li>
</ol>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.feed_load.transform_new">
<tt class="descclassname">caravel.feed.feed_load.</tt><tt class="descname">transform_new</tt><big>(</big><em>mappings</em>, <em>feed_iter</em>, <em>track_arrival</em>, <em>track_location</em>, <em>today=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/feed_load.html#transform_new"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.feed_load.transform_new" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
</div>
<div class="section" id="module-caravel.status.models">
<span id="status"></span><h3>Status<a class="headerlink" href="#module-caravel.status.models" title="Permalink to this headline">¶</a></h3>
<p>Caravel Status object definitions.</p>
<span class="target" id="module-caravel.status.status_load"></span><p>Caravel ETL of real-time-feed with mappings
from source encodings to GTFS keys.</p>
<ol class="arabic simple">
<li>Get the next position report with the mapping applied.<ul>
<li>Locations have precious little additional information.</li>
<li>Arrivals, however, have plenty of additional data, including
Route, Direction and Stop.</li>
</ul>
</li>
<li>Track route, route-stop, stop and vehicle status.</li>
<li>Clean up old status reports.</li>
</ol>
<div class="section" id="id3">
<h4>Components<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="caravel.status.status_load.update_route">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">update_route</tt><big>(</big><em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#update_route"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.update_route" title="Permalink to this definition">¶</a></dt>
<dd><p>Add to today&#8217;s route/direction documents.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.update_route_stop">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">update_route_stop</tt><big>(</big><em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#update_route_stop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.update_route_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Add to today&#8217;s route/direction/stop documents.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.update_stop">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">update_stop</tt><big>(</big><em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#update_stop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.update_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Add to today&#8217;s Stop documents.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.update_vehicle">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">update_vehicle</tt><big>(</big><em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#update_vehicle"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.update_vehicle" title="Permalink to this definition">¶</a></dt>
<dd><p>Add to today&#8217;s vehicle documents at this stop.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.track_arrival">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">track_arrival</tt><big>(</big><em>mappings</em>, <em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#track_arrival"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.track_arrival" title="Permalink to this definition">¶</a></dt>
<dd><p>Apply mappings.  Create or update status objects.</p>
<p>Use a Hard-wired mapping for direction.</p>
<p>Apply current mappings for route, vehicle and stop.
If (a) the mapping exists and (b) the value is in the mapping</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.track_location">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">track_location</tt><big>(</big><em>mappings</em>, <em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#track_location"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.track_location" title="Permalink to this definition">¶</a></dt>
<dd><p>Track a simple location report.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.old_status_removal">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">old_status_removal</tt><big>(</big><em>db</em>, <em>today=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#old_status_removal"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.old_status_removal" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove old Route, RouteStop and Vehicle reports.</p>
<p>This should only be run once in a great while.</p>
</dd></dl>

</div>
</div>
<div class="section" id="module-caravel.transit_system">
<span id="transit-system"></span><h3>Transit System<a class="headerlink" href="#module-caravel.transit_system" title="Permalink to this headline">¶</a></h3>
<p>Caravel Transit System &#8220;database&#8221;.</p>
<p>This reads the various files that define the transit system to
create an in-memory database.</p>
<ul class="simple">
<li>calendar.txt</li>
<li>calendar_dates.txt</li>
<li>routes.txt</li>
<li>stops.txt</li>
<li>trips.txt</li>
<li>stop_times.txt</li>
</ul>
<p>Transit System Source</p>
<div class="highlight-python"><pre>http://googletf.gohrt.com/google_transit.zip</pre>
</div>
<div class="section" id="acquisition">
<h4>Acquisition<a class="headerlink" href="#acquisition" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="caravel.transit_system.get_source_data">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_source_data</tt><big>(</big><em>connection=None</em>, <em>target_dir='.'</em>, <em>url=None</em><big>)</big><a class="headerlink" href="#caravel.transit_system.get_source_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the lastest Route Definition ZIP Archive.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>connection</strong> &#8211; Override to the default of urllib2.OpenerDirector.</li>
<li><strong>target_dir</strong> &#8211; Working directory for result file</li>
<li><strong>url</strong> &#8211; URL for the file (<a class="reference external" href="http://googletf.gohrt.com/google_transit.zip">http://googletf.gohrt.com/google_transit.zip</a>)</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="transit-objects">
<h4>Transit Objects<a class="headerlink" href="#transit-objects" title="Permalink to this headline">¶</a></h4>
<dl class="class">
<dt id="caravel.transit_system.Calendar">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">Calendar</tt><a class="headerlink" href="#caravel.transit_system.Calendar" title="Permalink to this definition">¶</a></dt>
<dd><p>Calendar(service_id, monday, tuesday, wednesday, thursday, friday, saturday, sunday, start_date, end_date)</p>
</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.Calendar_Date">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">Calendar_Date</tt><a class="headerlink" href="#caravel.transit_system.Calendar_Date" title="Permalink to this definition">¶</a></dt>
<dd><p>Calendar_Date(service_id, date, exception_type)</p>
</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.Route">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">Route</tt><a class="headerlink" href="#caravel.transit_system.Route" title="Permalink to this definition">¶</a></dt>
<dd><p>Route(route_id, route_short_name, route_long_name, route_desc, route_type, route_url)</p>
</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.Stop">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">Stop</tt><a class="headerlink" href="#caravel.transit_system.Stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Stop(stop_id, stop_name, stop_lat, stop_lon)</p>
</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.Trip">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">Trip</tt><a class="headerlink" href="#caravel.transit_system.Trip" title="Permalink to this definition">¶</a></dt>
<dd><p>Trip(route_id, service_id, trip_id, direction_id, block_id)</p>
</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.Stop_Time">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">Stop_Time</tt><a class="headerlink" href="#caravel.transit_system.Stop_Time" title="Permalink to this definition">¶</a></dt>
<dd><p>Stop_Time(trip_id, arrival_time, departure_time, stop_id, stop_sequence, timepoint)</p>
</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.Candidate">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">Candidate</tt><a class="headerlink" href="#caravel.transit_system.Candidate" title="Permalink to this definition">¶</a></dt>
<dd><p>Candidate(distance, time, stop, stop_time)</p>
</dd></dl>

</div>
<div class="section" id="transit-connection">
<h4>Transit &#8220;Connection&#8221;<a class="headerlink" href="#transit-connection" title="Permalink to this headline">¶</a></h4>
<p>This is a database-like object.</p>
<dl class="class">
<dt id="caravel.transit_system.Accessor">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">Accessor</tt><a class="reference internal" href="../_modules/caravel/transit_system.html#Accessor"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.Accessor" title="Permalink to this definition">¶</a></dt>
<dd><p>Abstract superclass to unify access to a directory and access to
a ZIP archive.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.AccessZip">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">AccessZip</tt><big>(</big><em>archive</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#AccessZip"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.AccessZip" title="Permalink to this definition">¶</a></dt>
<dd><p>Access a ZIP archive.</p>
<dl class="method">
<dt id="caravel.transit_system.AccessZip.open">
<tt class="descname">open</tt><big>(</big><em>name</em>, <em>mode='r'</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#AccessZip.open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.AccessZip.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns an open file object for the named member.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.AccessDir">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">AccessDir</tt><big>(</big><em>base</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#AccessDir"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.AccessDir" title="Permalink to this definition">¶</a></dt>
<dd><p>Access a Directory (an archive that&#8217;s been expanded.)</p>
<dl class="method">
<dt id="caravel.transit_system.AccessDir.open">
<tt class="descname">open</tt><big>(</big><em>name</em>, <em>mode='rb'</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#AccessDir.open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.AccessDir.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns an open file object for the named member.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.Connection">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.</tt><tt class="descname">Connection</tt><a class="reference internal" href="../_modules/caravel/transit_system.html#Connection"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.Connection" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a database-like connection to the transit data.
This will eagerly load all the files, creating a large (but fast) in-memory database.</p>
<dl class="method">
<dt id="caravel.transit_system.Connection.open">
<tt class="descname">open</tt><big>(</big><em>base</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#Connection.open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.Connection.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Open the given .ZIP file or directory.  This will eagerly load
the files.  It takes a second or two.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>base</strong> &#8211; Directory name or .ZIP file name.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="staticmethod">
<dt id="caravel.transit_system.Connection.time_parse">
<em class="property">static </em><tt class="descname">time_parse</tt><big>(</big><em>string</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#Connection.time_parse"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.Connection.time_parse" title="Permalink to this definition">¶</a></dt>
<dd><p>Transform HH:MM:SS string into seconds past midnight.
Unlike <tt class="xref py py-mod docutils literal"><span class="pre">datetime</span></tt>, this does not mind times &gt;= 24:00:00.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>string</strong> &#8211; String of the form HH:MM:SS</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">seconds past midnigth</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="query-functions">
<h4>Query Functions<a class="headerlink" href="#query-functions" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="caravel.transit_system.radians">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">radians</tt><big>(</big><em>degrees</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#radians"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.radians" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert Lat/Lon degrees to radians.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>degrees</strong> &#8211; Latitude or Longitude</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Radians</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.degrees">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">degrees</tt><big>(</big><em>radians</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#degrees"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.degrees" title="Permalink to this definition">¶</a></dt>
<dd><p>Convert radians to Lat/Lon degrees.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>radians</strong> &#8211; angle in radians, usually from a distance calculation</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Degrees</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.dist_approx">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">dist_approx</tt><big>(</big><em>p1</em>, <em>p2</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#dist_approx"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.dist_approx" title="Permalink to this definition">¶</a></dt>
<dd><p>The Equirectangular Approximation for distance between two coordinates.
Fast and reasonably accurate.</p>
<p>See <a class="reference internal" href="../design/distance.html#design-distance"><em>Distance Calculations</em></a> for details.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>p1</strong> &#8211; (lat,lon) 2-tuple</li>
<li><strong>p2</strong> &#8211; (lat,lon) 2-tuple</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">distance in statute miles.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_services_today">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_services_today</tt><big>(</big><em>conn</em>, <em>today=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_services_today"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_services_today" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the Service ID applicable today.
Examines calendar and calendar dates.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>today</strong> &#8211; A <tt class="xref py py-class docutils literal"><span class="pre">datetime.date</span></tt> object.
If omitted, the current date is used.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">A sequence of service id strings that apply to this date.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_closest_stops">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_closest_stops</tt><big>(</big><em>conn</em>, <em>lat_lon</em>, <em>max_dist=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_closest_stops"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_closest_stops" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a lat/lon pair, locate nearby stops.</p>
<p>Handles the following REST requests.</p>
<p><tt class="samp docutils literal"><span class="pre">/stop/?latlng=</span><em><span class="pre">nn.nnnnnn,mm.mmmmmm</span></em></tt></p>
<blockquote>
<div>This can find the nearest stops to this coordinate.</div></blockquote>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>lat_lon</strong> &#8211; A (lat,lon) 2-tuple</li>
<li><strong>max_dist</strong> &#8211; An upper limit on distances to examine</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterator over (distance,stop) pairs ordered from nearest to
the specified max_dist value.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_closest_times_in_service">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_closest_times_in_service</tt><big>(</big><em>conn</em>, <em>stop_id</em>, <em>time</em>, <em>services</em>, <em>min_time=None</em>, <em>max_time=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_closest_times_in_service"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_closest_times_in_service" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a stop and a time, locate the scheduled stop_time closest to this.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>stop_id</strong> &#8211; The id for a stop</li>
<li><strong>time</strong> &#8211; The seconds-after-midnight time</li>
<li><strong>services</strong> &#8211; The iterable sequence of services applicable</li>
<li><strong>min_time</strong> &#8211; The lower limit on seconds prior to the scheduled time.
Usually, this is a negative number.</li>
<li><strong>max_time</strong> &#8211; The upper limit on seconds after the the scheduled time.
This is a positive number.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterator over (time,stop_time) pairs ordered from closest in time
to the max_time value.  The absolute magnitude is used for sorting
so early and late times will be intermixed.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_candidate_stops">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_candidate_stops</tt><big>(</big><em>conn</em>, <em>lat_lon</em>, <em>time</em>, <em>services</em>, <em>max_dist=None</em>, <em>min_time=None</em>, <em>max_time=None</em>, <em>count=6</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_candidate_stops"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_candidate_stops" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute the most likely stops to match a report&#8217;s lat/lon and time.
This will use <a class="reference internal" href="#caravel.transit_system.get_closest_stops" title="caravel.transit_system.get_closest_stops"><tt class="xref py py-meth docutils literal"><span class="pre">get_closest_stops()</span></tt></a> to locate a collection of likely stops.
For each stop, <a class="reference internal" href="#caravel.transit_system.get_closest_times_in_service" title="caravel.transit_system.get_closest_times_in_service"><tt class="xref py py-meth docutils literal"><span class="pre">get_closest_times_in_service()</span></tt></a> is used to locate the
most likely scheduled time before or after the reported time.</p>
<p>Initial surveys of the data provided guidance on the upper bounds
for time and distance matching.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>lat_lon</strong> &#8211; A (lat,lon) tuple from a <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a> instance.</li>
<li><strong>time</strong> &#8211; A time (seconds past midnight) from a <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a> instance.</li>
<li><strong>services</strong> &#8211; The iterable sequence of services applicable</li>
<li><strong>max_dist</strong> &#8211; An upper limit on distances to examine.  The default value is 0.1 mile.</li>
<li><strong>min_time</strong> &#8211; The lower limit on seconds prior to the scheduled time.
Usually, this is a negative number.  The default is about -180 seconds.</li>
<li><strong>max_time</strong> &#8211; The upper limit on seconds after the the scheduled time.
This is a positive number.  The default is about 360 seconds.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_route_from_stop_time">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_route_from_stop_time</tt><big>(</big><em>conn</em>, <em>stop_time</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_route_from_stop_time"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_route_from_stop_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Query the route that contains a given stop_time value.
This does a stop_times JOIN trips JOIN routes query.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>stop_time</strong> &#8211; a <a class="reference internal" href="#caravel.transit_system.Stop_Time" title="caravel.transit_system.Stop_Time"><tt class="xref py py-class docutils literal"><span class="pre">Stop_Time</span></tt></a> instance.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">a <a class="reference internal" href="#caravel.transit_system.Route" title="caravel.transit_system.Route"><tt class="xref py py-class docutils literal"><span class="pre">Route</span></tt></a> instance.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_trip_from_stop_time">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_trip_from_stop_time</tt><big>(</big><em>conn</em>, <em>stop_time</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_trip_from_stop_time"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_trip_from_stop_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Query the trip that contains a given stop_time value.
This does a stop_times JOIN trips JOIN routes query.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>stop_time</strong> &#8211; a <a class="reference internal" href="#caravel.transit_system.Stop_Time" title="caravel.transit_system.Stop_Time"><tt class="xref py py-class docutils literal"><span class="pre">Stop_Time</span></tt></a> instance.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">a <a class="reference internal" href="#caravel.transit_system.Trip" title="caravel.transit_system.Trip"><tt class="xref py py-class docutils literal"><span class="pre">Trip</span></tt></a> instance.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_next_stop_time">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_next_stop_time</tt><big>(</big><em>conn</em>, <em>stop_time</em>, <em>services</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_next_stop_time"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_next_stop_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a <a class="reference internal" href="#caravel.transit_system.Stop_Time" title="caravel.transit_system.Stop_Time"><tt class="xref py py-class docutils literal"><span class="pre">Stop_Time</span></tt></a> object, locate the remaining
sequence of stops.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>stop_time</strong> &#8211; A <a class="reference internal" href="#caravel.transit_system.Stop_Time" title="caravel.transit_system.Stop_Time"><tt class="xref py py-class docutils literal"><span class="pre">Stop_Time</span></tt></a> object</li>
<li><strong>services</strong> &#8211; The iterable sequence of services applicable</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterator over (time,stop_time) pairs ordered from closest in time
to the max_time value.  The absolute magnitude is used for sorting
so early and late times will be intermixed.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_route">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_route</tt><big>(</big><em>conn</em>, <em>id=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_route"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_route" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns route or list of routes.
Handles the following REST requests.</p>
<p><tt class="samp docutils literal"><span class="pre">/route/</span></tt></p>
<blockquote>
<div>The route list.  All 70.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/route/</span><em><span class="pre">id</span></em><span class="pre">/</span></tt></p>
<blockquote>
<div>All stops along the route, each stop decorated with direction and service.
The time-of-day details for a given trip are not provided; they are associated
with a specific stop.</div></blockquote>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>id</strong> &#8211; Optional route id.  If no route id, all routes are returned.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">route or list of routes.  Each route is a 3-tuple of (route, trip_list)
Each trip list is a sequence of stop_times.  Stop details are not included.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_stop">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_stop</tt><big>(</big><em>conn</em>, <em>id=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_stop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns stop or list of stops.
Handles the following REST requests.</p>
<p><tt class="samp docutils literal"><span class="pre">/stop/</span></tt></p>
<blockquote>
<div>All 3210 stops.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/stop/</span><em><span class="pre">id</span></em><span class="pre">/</span></tt></p>
<blockquote>
<div>A specific stop.</div></blockquote>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_route_stops">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_route_stops</tt><big>(</big><em>conn</em>, <em>id</em>, <em>dir=None</em>, <em>date=None</em>, <em>time=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_route_stops"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_route_stops" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a route with a list of stops on that route.
Handles the following REST requests.</p>
<p><tt class="samp docutils literal"><span class="pre">/route/</span><em><span class="pre">id</span></em><span class="pre">/</span><em><span class="pre">dir</span></em></tt></p>
<blockquote>
<div>All stops in a particular direction along the route.  The direction is
more-or-less inoound or outbound, and is actually a foreign key to a direction
table.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/route/</span><em><span class="pre">id</span></em><span class="pre">/?date=</span><em><span class="pre">date</span></em></tt></p>
<blockquote>
<div>All stops along the route filtered by services available on the given date.
Day of week is generally sufficient, but there are calendar overrides,
so full date is required.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/route/</span><em><span class="pre">id</span></em><span class="pre">/?date=</span><em><span class="pre">date</span></em><span class="pre">&amp;time=</span><em><span class="pre">time</span></em></tt></p>
<blockquote>
<div>All stops along the route, filtered by services available on the given date
on or after the given time.  If these are ordered by distance (along the route&#8217;s
direction) it should provide a tidy summary of the route.</div></blockquote>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>id</strong> &#8211; route id.</li>
<li><strong>dir</strong> &#8211; optional direction, codes are &#8216;1&#8217; and &#8216;0&#8217;.</li>
<li><strong>date</strong> &#8211; a datetime.date object; the services available on this date
are used to filter the results.</li>
<li><strong>time</strong> &#8211; a seconds-after-midnight time.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_stop_times">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_stop_times</tt><big>(</big><em>conn</em>, <em>id</em>, <em>dir=None</em>, <em>date=None</em>, <em>time=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_stop_times"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_stop_times" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a stop with a list of stop times.
Handles the following REST requests.</p>
<p><tt class="samp docutils literal"><span class="pre">/stop/</span><em><span class="pre">id</span></em><span class="pre">/?dir=</span><em><span class="pre">dir</span></em></tt></p>
<blockquote>
<div>All stop times for this stop constrained by trip direction.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/stop/</span><em><span class="pre">id</span></em><span class="pre">/?dir=</span><em><span class="pre">dir</span></em><span class="pre">&amp;date=</span><em><span class="pre">date</span></em></tt></p>
<blockquote>
<div>All stop times for this stop constrained by services on the specific date.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/stop/</span><em><span class="pre">id</span></em><span class="pre">/?dir=</span><em><span class="pre">dir</span></em><span class="pre">&amp;date=</span><em><span class="pre">date</span></em><span class="pre">&amp;time=</span><em><span class="pre">time</span></em></tt></p>
<p>All stop times at this stop, filtered by services available on the given date
on or after the given time</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>id</strong> &#8211; stop id.</li>
<li><strong>dir</strong> &#8211; optional route direction, codes are &#8216;1&#8217; and &#8216;0&#8217;.</li>
<li><strong>date</strong> &#8211; a datetime.date object; the services available on this date
are used to filter the results.</li>
<li><strong>time</strong> &#8211; a seconds-after-midnight time.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_closest_stops_filtered">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_closest_stops_filtered</tt><big>(</big><em>conn</em>, <em>lat_lon</em>, <em>max_dist=None</em>, <em>dir=None</em>, <em>date=None</em>, <em>time=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_closest_stops_filtered"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_closest_stops_filtered" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a lat/lon pair, locate nearby stops.</p>
<p>Handles the following REST requests.</p>
<p><tt class="samp docutils literal"><span class="pre">/stop/?latlng=</span><em><span class="pre">nn.nnnnnn,mm.mmmmmm</span></em><span class="pre">&amp;dir=</span><em><span class="pre">dir</span></em></tt></p>
<blockquote>
<div>This can find the nearest stops for all routes heading in this direction.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/stop/?latlng=</span><em><span class="pre">nn.nnnnnn,mm.mmmmmm</span></em><span class="pre">&amp;date=</span><em><span class="pre">date</span></em></tt></p>
<blockquote>
<div>This finds the nearest stops with a service that is active on the given date.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/stop/?latlng=</span><em><span class="pre">nn.nnnnnn,mm.mmmmmm</span></em><span class="pre">&amp;time=</span><em><span class="pre">time</span></em></tt></p>
<blockquote>
<div>This finds the nearest stops with a service that is active on the given date
and on or after the given time.</div></blockquote>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>lat_lon</strong> &#8211; A (lat,lon) 2-tuple</li>
<li><strong>dir</strong> &#8211; A trip direction_id</li>
<li><strong>max_dist</strong> &#8211; An upper limit on distances to examine</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterator over (distance,stop) pairs ordered from nearest to
the specified max_dist value.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.get_closest_routes_filtered">
<tt class="descclassname">caravel.transit_system.</tt><tt class="descname">get_closest_routes_filtered</tt><big>(</big><em>conn</em>, <em>lat_lon</em>, <em>id</em>, <em>dir=None</em>, <em>max_dist=None</em>, <em>date=None</em>, <em>time=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system.html#get_closest_routes_filtered"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.get_closest_routes_filtered" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a lat/lon pair, locate nearby stops on a given route.</p>
<p>Handles the following REST requests.</p>
<p><tt class="samp docutils literal"><span class="pre">/route/</span><em><span class="pre">id</span></em><span class="pre">/?latlng=</span><em><span class="pre">nn.nnnnnn,mm.mmmmmm</span></em></tt></p>
<blockquote>
<div>This can find the nearest stops on the given route to this coordinate.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/route/</span><em><span class="pre">id</span></em><span class="pre">/</span><em><span class="pre">dir</span></em><span class="pre">/?latlng=</span><em><span class="pre">nn.nnnnnn,mm.mmmmmm</span></em></tt></p>
<blockquote>
<div>This can find the nearest stops on the given route and direction to this coordinate.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/route/</span><em><span class="pre">id</span></em><span class="pre">/</span><em><span class="pre">dir</span></em><span class="pre">/?latlng=</span><em><span class="pre">nn.nnnnnn,mm.mmmmmm</span></em><span class="pre">&amp;date=</span><em><span class="pre">date</span></em></tt></p>
<blockquote>
<div>This can find the nearest stops on the given route and direction to this coordinate
active on the given date.</div></blockquote>
<p><tt class="samp docutils literal"><span class="pre">/route/</span><em><span class="pre">id</span></em><span class="pre">/</span><em><span class="pre">dir</span></em><span class="pre">/?latlng=</span><em><span class="pre">nn.nnnnnn,mm.mmmmmm</span></em><span class="pre">&amp;date=</span><em><span class="pre">date</span></em><span class="pre">&amp;time=</span><em><span class="pre">time</span></em></tt></p>
<blockquote>
<div>This can find the nearest stops on the given route and direction to this coordinate
active on the given date and on or after the given time.</div></blockquote>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>conn</strong> &#8211; An open <a class="reference internal" href="#caravel.transit_system.Connection" title="caravel.transit_system.Connection"><tt class="xref py py-class docutils literal"><span class="pre">Connection</span></tt></a>.</li>
<li><strong>lat_lon</strong> &#8211; A (lat,lon) 2-tuple</li>
<li><strong>dir</strong> &#8211; A trip direction_id</li>
<li><strong>max_dist</strong> &#8211; An upper limit on distances to examine</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Paran id:</th><td class="field-body"><p class="first">route id</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterator over (distance,stop) pairs ordered from nearest to
the specified max_dist value.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
</div>
<div class="section" id="analysis-and-profiling">
<h2>Analysis and Profiling<a class="headerlink" href="#analysis-and-profiling" title="Permalink to this headline">¶</a></h2>
<p>These are analysis and profiling modules and applications.</p>
<div class="section" id="module-caravel.statistics">
<span id="statistics"></span><h3>Statistics<a class="headerlink" href="#module-caravel.statistics" title="Permalink to this headline">¶</a></h3>
<p>Statistics tools for working with frequency counts.</p>
<dl class="class">
<dt id="caravel.statistics.FQTable">
<em class="property">class </em><tt class="descclassname">caravel.statistics.</tt><tt class="descname">FQTable</tt><a class="reference internal" href="../_modules/caravel/statistics.html#FQTable"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.statistics.FQTable" title="Permalink to this definition">¶</a></dt>
<dd><p>Subclass of <tt class="xref py py-class docutils literal"><span class="pre">collections.defaultdict</span></tt> that
enforces an integer count similar to <tt class="xref py py-class docutils literal"><span class="pre">collections.Count</span></tt>
but also adds mean and standard deviation descriptive statistics.</p>
<p>Note that the summary statistics are stateful; they&#8217;re computed
once and memoized.  They must be manually reset of the collection
is changed.</p>
<dl class="method">
<dt id="caravel.statistics.FQTable.mean">
<tt class="descname">mean</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/caravel/statistics.html#FQTable.mean"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.statistics.FQTable.mean" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the mean of this frequency table.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">mean</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.statistics.FQTable.reset">
<tt class="descname">reset</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/caravel/statistics.html#FQTable.reset"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.statistics.FQTable.reset" title="Permalink to this definition">¶</a></dt>
<dd><p>Reset the descriptive statistics.</p>
</dd></dl>

<dl class="method">
<dt id="caravel.statistics.FQTable.sd">
<tt class="descname">sd</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/caravel/statistics.html#FQTable.sd"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.statistics.FQTable.sd" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the standard deviation of this frequency table.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">standard deviation.  Returns None if there are fewer
than 2 items.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div>
<div class="section" id="module-caravel.arrival_stats">
<span id="arrival-statistics"></span><h3>Arrival Statistics<a class="headerlink" href="#module-caravel.arrival_stats" title="Permalink to this headline">¶</a></h3>
<p>Caravel Arrival Time and Location Matching Statistics</p>
<p>This examines a suite of *.rpt files to get a bunch of Arrival and Dwell
reports.  It matches the Arrival and Dwell reports against the transit map,
getting a fairly large number of candidate matches.</p>
<dl class="function">
<dt id="caravel.arrival_stats.arrival_stats">
<tt class="descclassname">caravel.arrival_stats.</tt><tt class="descname">arrival_stats</tt><big>(</big><em>reader</em>, <em>conn</em>, <em>base='.'</em><big>)</big><a class="reference internal" href="../_modules/caravel/arrival_stats.html#arrival_stats"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.arrival_stats.arrival_stats" title="Permalink to this definition">¶</a></dt>
<dd><p>Use the <tt class="xref py py-meth docutils literal"><span class="pre">transit_system.connection.get_candidate_stops()</span></tt> to locate
stops.  Compare the shortest distance stop with stops farther away to see
if the time match of a later stop is better than the time match of the
closest stop.</p>
</dd></dl>

</div>
<div class="section" id="module-caravel.transit_stats">
<span id="transit-system-statistics"></span><h3>Transit System Statistics<a class="headerlink" href="#module-caravel.transit_stats" title="Permalink to this headline">¶</a></h3>
<p>Caravel Transit System Statistics</p>
<p>This computes the overall average time between stops along all routes.</p>
<p>It computes the overall average distance between stops along all routes.</p>
<dl class="function">
<dt id="caravel.transit_stats.route_size">
<tt class="descclassname">caravel.transit_stats.</tt><tt class="descname">route_size</tt><big>(</big><em>conn</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_stats.html#route_size"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_stats.route_size" title="Permalink to this definition">¶</a></dt>
<dd><p>Examine all stops to get the complete bounding rectangle
of lat/lon coordinates.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_stats.route_stop_stats">
<tt class="descclassname">caravel.transit_stats.</tt><tt class="descname">route_stop_stats</tt><big>(</big><em>conn</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_stats.html#route_stop_stats"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_stats.route_stop_stats" title="Permalink to this definition">¶</a></dt>
<dd><p>These are simple descriptive statistics of distances
between stops and distances between arrival times along
the defined routes.</p>
</dd></dl>

</div>
</div>
<div class="section" id="applications">
<h2>Applications<a class="headerlink" href="#applications" title="Permalink to this headline">¶</a></h2>
<p>These are top-level applications to produce useful results.</p>
<div class="section" id="module-caravel.arrival_at_stop">
<span id="arrival-at-stop"></span><h3>Arrival At Stop<a class="headerlink" href="#module-caravel.arrival_at_stop" title="Permalink to this headline">¶</a></h3>
<p>From live Arrival and Dwell records, compute the closest stop.</p>
<p>Synopsis</p>
<div class="highlight-python"><pre>python -m caraval.arrival_at_stop -t hrt_20120218_0425 *.rpt</pre>
</div>
<p>Description</p>
<blockquote>
<div><p>Uses the supplied transit information directory to gather information
on the transit system.</p>
<p>Reads the given raw *.rpt feed to get bus Reports.</p>
<p>Each Arrival or Dwell report is matched against a stop to determine where
the vehicle is and how it stands with respect to it&#8217;s schedule.
This creates a CSV file with the Report, Stop, Stop Time, Route and Trip information.</p>
<p>Some Reports cannot be matched against a stop, these reports are written
to a &#8220;reject&#8221; file, possibly including one or two stops near the report.</p>
</div></blockquote>
<p>Options</p>
<blockquote>
<div><dl class="option">
<dt>
<tt class="descname">*.rpt...</tt></dt>
<dd><p>List of source files to process.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-arrival_at_stop--format">
<tt class="descname">--format</tt><tt class="descclassname"> number</tt><a class="headerlink" href="#cmdoption-arrival_at_stop--format" title="Permalink to this definition">¶</a></dt>
<dd><p>Format number.  Generally maps to a subclass of <a class="reference internal" href="#caravel.report.ReportReader" title="caravel.report.ReportReader"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.ReportReader</span></tt></a>.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-arrival_at_stop--new">
<tt class="descname">--new</tt><tt class="descclassname"></tt><a class="headerlink" href="#cmdoption-arrival_at_stop--new" title="Permalink to this definition">¶</a></dt>
<dd><p>Get a new .rpt file and process it.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-arrival_at_stop--transit">
<tt class="descname">--transit</tt><tt class="descclassname"> transit_details</tt><tt class="descclassname">, </tt><tt class="descname">-t</tt><tt class="descclassname"> transit_details</tt><a class="headerlink" href="#cmdoption-arrival_at_stop--transit" title="Permalink to this definition">¶</a></dt>
<dd><p>Directory (or .ZIP) with HRT details.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-arrival_at_stop--reject">
<tt class="descname">--reject</tt><tt class="descclassname"> no_stop.csv</tt><tt class="descclassname">, </tt><tt class="descname">-r</tt><tt class="descclassname"> no_stop.csv</tt><a class="headerlink" href="#cmdoption-arrival_at_stop--reject" title="Permalink to this definition">¶</a></dt>
<dd><p>Reject file to which Reports are written for which there is no stop.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-arrival_at_stop--stop">
<tt class="descname">--stop</tt><tt class="descclassname"> stop.csv</tt><tt class="descclassname">, </tt><tt class="descname">-s</tt><tt class="descclassname"> stop.csv</tt><a class="headerlink" href="#cmdoption-arrival_at_stop--stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Stops file to which Report, Stop, Stop Time, Route and Trip information
is written.</p>
</dd></dl>

</div></blockquote>
<p>Algorithm Components</p>
<blockquote>
<div><p>The core stop-finding algorithm is implemented via the <a class="reference internal" href="#caravel.arrival_at_stop.StopFinder" title="caravel.arrival_at_stop.StopFinder"><tt class="xref py py-class docutils literal"><span class="pre">StopFinder</span></tt></a>
class hierarchy.</p>
<p>The <a class="reference internal" href="#caravel.arrival_at_stop.arrival_at_stop" title="caravel.arrival_at_stop.arrival_at_stop"><tt class="xref py py-func docutils literal"><span class="pre">arrival_at_stop()</span></tt></a> process applies this algorithm, and writes
the successful results using a <a class="reference internal" href="#caravel.arrival_at_stop.WriteStop" title="caravel.arrival_at_stop.WriteStop"><tt class="xref py py-class docutils literal"><span class="pre">WriteStop</span></tt></a> instance.  The failures
are written using a <a class="reference internal" href="#caravel.arrival_at_stop.WriteNoStop" title="caravel.arrival_at_stop.WriteNoStop"><tt class="xref py py-class docutils literal"><span class="pre">WriteNoStop</span></tt></a> instance.</p>
<dl class="function">
<dt id="caravel.arrival_at_stop.arrival_at_stop">
<tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">arrival_at_stop</tt><big>(</big><em>reader</em>, <em>stop_finder</em>, <em>files</em>, <em>no_stop=&lt;built-in function print&gt;</em>, <em>stop=&lt;built-in function print&gt;</em><big>)</big><a class="reference internal" href="../_modules/caravel/arrival_at_stop.html#arrival_at_stop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.arrival_at_stop.arrival_at_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Locate closest stop to the Report objects in the given file(s).
Create two outputs via callback functions.</p>
<ul>
<li><p class="first"><tt class="docutils literal"><span class="pre">no_stop</span></tt> is called with reports to which a stop could not be reliably assigned.
This function is called with four positional parameters.</p>
<dl class="function">
<dt id="caravel.arrival_at_stop.no_stop">
<tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">no_stop</tt><big>(</big><em>message</em>, <em>report</em>, <em>candidate_1</em>, <em>candidate_2</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.no_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Callback function to write a report that could not be matched
reliably to a stop.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>message</strong> &#8211; Short string explanation</li>
<li><strong>report</strong> &#8211; <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a> object</li>
<li><strong>candidate_1</strong> &#8211; <a class="reference internal" href="#caravel.transit_system.Stop" title="caravel.transit_system.Stop"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Stop</span></tt></a> object or <tt class="docutils literal"><span class="pre">None</span></tt></li>
<li><strong>candidate_2</strong> &#8211; <a class="reference internal" href="#caravel.transit_system.Stop" title="caravel.transit_system.Stop"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Stop</span></tt></a> object or <tt class="docutils literal"><span class="pre">None</span></tt></li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">stop</span></tt> is called with the reports to which a stop could be assigned.</p>
<dl class="function">
<dt id="caravel.arrival_at_stop.stop">
<tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">stop</tt><big>(</big><em>report</em>, <em>best_fit</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Callback function to write a report was matched
reliably to a stop.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>report</strong> &#8211; <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a> object</li>
<li><strong>best_fit</strong> &#8211; <a class="reference internal" href="#caravel.transit_system.Candidate" title="caravel.transit_system.Candidate"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Candidate</span></tt></a> object</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>reader</strong> &#8211; An object of <a class="reference internal" href="#caravel.report.ReportReader" title="caravel.report.ReportReader"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.ReportReader</span></tt></a>.</li>
<li><strong>stop_finder</strong> &#8211; An  <a class="reference internal" href="#caravel.arrival_at_stop.StopFinder" title="caravel.arrival_at_stop.StopFinder"><tt class="xref py py-class docutils literal"><span class="pre">StopFinder</span></tt></a> instance.</li>
<li><strong>files</strong> &#8211; a sequence of report files.</li>
<li><strong>no_stop</strong> &#8211; an open file to which 4-tuples are written.</li>
<li><strong>stop</strong> &#8211; an open file to which 7-tuples are written.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">dictionary of counts</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="caravel.arrival_at_stop.InvalidReport">
<em class="property">class </em><tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">InvalidReport</tt><a class="headerlink" href="#caravel.arrival_at_stop.InvalidReport" title="Permalink to this definition">¶</a></dt>
<dd><p>The Report was either a Location or invalid in some other way
for locating a stop.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.arrival_at_stop.NoStopFound">
<em class="property">class </em><tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">NoStopFound</tt><a class="headerlink" href="#caravel.arrival_at_stop.NoStopFound" title="Permalink to this definition">¶</a></dt>
<dd><p>No stop could be found.  The arguments include
a message, and up to two candidate stops.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.arrival_at_stop.StopFinder">
<em class="property">class </em><tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">StopFinder</tt><big>(</big><em>connection</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder" title="Permalink to this definition">¶</a></dt>
<dd><p>The Stop-Finder algorithm.</p>
<dl class="staticmethod">
<dt id="caravel.arrival_at_stop.StopFinder.heading">
<em class="property">static </em><tt class="descname">heading</tt><big>(</big><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder.heading" title="Permalink to this definition">¶</a></dt>
<dd><p>Return headings which match the return value from <a class="reference internal" href="#caravel.arrival_at_stop.StopFinder.supplement" title="caravel.arrival_at_stop.StopFinder.supplement"><tt class="xref py py-meth docutils literal"><span class="pre">supplement()</span></tt></a>.</p>
</dd></dl>

<dl class="method">
<dt id="caravel.arrival_at_stop.StopFinder.process_report">
<tt class="descname">process_report</tt><big>(</big><em>report</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder.process_report" title="Permalink to this definition">¶</a></dt>
<dd><p>Process a single Arrival or Dwell report.</p>
<ol class="arabic simple">
<li>Get services available for this date.</li>
<li>Get closest stops.</li>
<li>Get stops closest in time.</li>
<li>Add supplemental data.</li>
</ol>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>report</strong> &#8211; <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a> instance.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.arrival_at_stop.StopFinder.supplement">
<tt class="descname">supplement</tt><big>(</big><em>candidate</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder.supplement" title="Permalink to this definition">¶</a></dt>
<dd><p>Fold in supplemental data.  The superclass does nothing extra.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>best_fit</strong> &#8211; a <a class="reference internal" href="#caravel.transit_system.Candidate" title="caravel.transit_system.Candidate"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Candidate</span></tt></a> instance.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">a new Best_Fit instance or possibly the unmodified candidate.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.arrival_at_stop.StopFinder_Route_Trip">
<em class="property">class </em><tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">StopFinder_Route_Trip</tt><big>(</big><em>connection</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Route_Trip" title="Permalink to this definition">¶</a></dt>
<dd><p>The Stop-Finder algorithm.  This folds in route and trip
supplemental data.</p>
<dl class="class">
<dt id="caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit">
<em class="property">class </em><tt class="descname">Best_Fit</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit" title="Permalink to this definition">¶</a></dt>
<dd><p>Best_Fit(distance, time, stop, stop_time, route, trip)</p>
<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.distance">
<tt class="descname">distance</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.distance" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 0</p>
</dd></dl>

<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.route">
<tt class="descname">route</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.route" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 4</p>
</dd></dl>

<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.stop">
<tt class="descname">stop</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 2</p>
</dd></dl>

<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.stop_time">
<tt class="descname">stop_time</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.stop_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 3</p>
</dd></dl>

<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.time">
<tt class="descname">time</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.time" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 1</p>
</dd></dl>

<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.trip">
<tt class="descname">trip</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit.trip" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 5</p>
</dd></dl>

</dd></dl>

<dl class="staticmethod">
<dt id="caravel.arrival_at_stop.StopFinder_Route_Trip.heading">
<em class="property">static </em><tt class="descclassname">StopFinder_Route_Trip.</tt><tt class="descname">heading</tt><big>(</big><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.heading" title="Permalink to this definition">¶</a></dt>
<dd><p>Return headings which match the return value from <a class="reference internal" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.supplement" title="caravel.arrival_at_stop.StopFinder_Route_Trip.supplement"><tt class="xref py py-meth docutils literal"><span class="pre">supplement()</span></tt></a>.</p>
</dd></dl>

<dl class="method">
<dt id="caravel.arrival_at_stop.StopFinder_Route_Trip.supplement">
<tt class="descclassname">StopFinder_Route_Trip.</tt><tt class="descname">supplement</tt><big>(</big><em>best_fit</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.supplement" title="Permalink to this definition">¶</a></dt>
<dd><p>Fold in some extra data, the route and trip that apply to this stop.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>best_fit</strong> &#8211; <a class="reference internal" href="#caravel.transit_system.Candidate" title="caravel.transit_system.Candidate"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Candidate</span></tt></a> object</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">a <a class="reference internal" href="#caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit" title="caravel.arrival_at_stop.StopFinder_Route_Trip.Best_Fit"><tt class="xref py py-class docutils literal"><span class="pre">StopFinder_Route_Trip.Best_Fit</span></tt></a> instance.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.arrival_at_stop.StopFinder_Next_Stop">
<em class="property">class </em><tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">StopFinder_Next_Stop</tt><big>(</big><em>connection</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Next_Stop" title="Permalink to this definition">¶</a></dt>
<dd><p>The Stop-Finder algorithm.  This folds in route and next stop_time
supplemental data.</p>
<dl class="class">
<dt id="caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit">
<em class="property">class </em><tt class="descname">Best_Fit</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit" title="Permalink to this definition">¶</a></dt>
<dd><p>Best_Fit(distance, time, stop, stop_time, route, next)</p>
<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.distance">
<tt class="descname">distance</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.distance" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 0</p>
</dd></dl>

<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.next">
<tt class="descname">next</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.next" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 5</p>
</dd></dl>

<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.route">
<tt class="descname">route</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.route" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 4</p>
</dd></dl>

<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.stop">
<tt class="descname">stop</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 2</p>
</dd></dl>

<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.stop_time">
<tt class="descname">stop_time</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.stop_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 3</p>
</dd></dl>

<dl class="attribute">
<dt id="caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.time">
<tt class="descname">time</tt><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit.time" title="Permalink to this definition">¶</a></dt>
<dd><p>Alias for field number 1</p>
</dd></dl>

</dd></dl>

<dl class="staticmethod">
<dt id="caravel.arrival_at_stop.StopFinder_Next_Stop.heading">
<em class="property">static </em><tt class="descclassname">StopFinder_Next_Stop.</tt><tt class="descname">heading</tt><big>(</big><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.heading" title="Permalink to this definition">¶</a></dt>
<dd><p>Return headings which match the return value from <a class="reference internal" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.supplement" title="caravel.arrival_at_stop.StopFinder_Next_Stop.supplement"><tt class="xref py py-meth docutils literal"><span class="pre">supplement()</span></tt></a>.</p>
</dd></dl>

<dl class="method">
<dt id="caravel.arrival_at_stop.StopFinder_Next_Stop.supplement">
<tt class="descclassname">StopFinder_Next_Stop.</tt><tt class="descname">supplement</tt><big>(</big><em>best_fit</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.supplement" title="Permalink to this definition">¶</a></dt>
<dd><p>Fold in some extra data, the next scheduled stop.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>best_fit</strong> &#8211; <a class="reference internal" href="#caravel.transit_system.Candidate" title="caravel.transit_system.Candidate"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Candidate</span></tt></a> object</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">a <a class="reference internal" href="#caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit" title="caravel.arrival_at_stop.StopFinder_Next_Stop.Best_Fit"><tt class="xref py py-class docutils literal"><span class="pre">StopFinder_Next_Stop.Best_Fit</span></tt></a> instance.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

</div></blockquote>
<p>Output Components</p>
<blockquote>
<div><dl class="function">
<dt id="caravel.arrival_at_stop.prefix_fields">
<tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">prefix_fields</tt><big>(</big><em>prefix</em>, <em>nt_class</em><big>)</big><a class="reference internal" href="../_modules/caravel/arrival_at_stop.html#prefix_fields"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.arrival_at_stop.prefix_fields" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the list of field names from a namedtuple with a prefix.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.arrival_at_stop.prefix_dict">
<tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">prefix_dict</tt><big>(</big><em>prefix</em>, <em>nt_obj</em><big>)</big><a class="reference internal" href="../_modules/caravel/arrival_at_stop.html#prefix_dict"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.arrival_at_stop.prefix_dict" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a dictionary from a namedtuple applying a prefix to the field names.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.arrival_at_stop.WriteStop">
<em class="property">class </em><tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">WriteStop</tt><big>(</big><em>stop_finder</em>, <em>target=None</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.WriteStop" title="Permalink to this definition">¶</a></dt>
<dd><p>A callable writer for reports that have been matched to a stop.
This creates a CSV-format file attributes from
<a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a>,
<a class="reference internal" href="#caravel.transit_system.Stop" title="caravel.transit_system.Stop"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Stop</span></tt></a>,
<a class="reference internal" href="#caravel.transit_system.Stop_Time" title="caravel.transit_system.Stop_Time"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Stop_Time</span></tt></a></p>
<p>How to create an object usable a callback with <a class="reference internal" href="#caravel.arrival_at_stop.arrival_at_stop" title="caravel.arrival_at_stop.arrival_at_stop"><tt class="xref py py-func docutils literal"><span class="pre">arrival_at_stop()</span></tt></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">stop</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stop_file</span><span class="p">:</span>
    <span class="n">stop</span><span class="o">=</span> <span class="n">Stop</span><span class="p">(</span> <span class="n">connection</span><span class="p">,</span> <span class="n">stop_file</span> <span class="p">)</span>
</pre></div>
</div>
<p>This creates a callable <tt class="docutils literal"><span class="pre">stop</span></tt> function that can be used like this</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">stop</span><span class="p">(</span> <span class="n">report</span><span class="p">,</span> <span class="n">candidate</span> <span class="p">)</span>
</pre></div>
</div>
<dl class="method">
<dt id="caravel.arrival_at_stop.WriteStop.__call__">
<tt class="descname">__call__</tt><big>(</big><em>report</em>, <em>best_fit</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.WriteStop.__call__" title="Permalink to this definition">¶</a></dt>
<dd><p>Write a row to the stop file.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>report</strong> &#8211; <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a> object</li>
<li><strong>services</strong> &#8211; sevice id&#8217;s appropriate to the report</li>
<li><strong>best_fit</strong> &#8211; <a class="reference internal" href="#caravel.transit_system.Candidate" title="caravel.transit_system.Candidate"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Candidate</span></tt></a> object</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.arrival_at_stop.WriteStop.__init__">
<tt class="descname">__init__</tt><big>(</big><em>stop_finder</em>, <em>target=None</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.WriteStop.__init__" title="Permalink to this definition">¶</a></dt>
<dd><p>Create the CSV writer around the target file.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>stop_finder</strong> &#8211; <a class="reference internal" href="#caravel.arrival_at_stop.StopFinder" title="caravel.arrival_at_stop.StopFinder"><tt class="xref py py-class docutils literal"><span class="pre">StopFinder</span></tt></a> object.</li>
<li><strong>target</strong> &#8211; file-like object suitable to CSV writer.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.arrival_at_stop.WriteNoStop">
<em class="property">class </em><tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">WriteNoStop</tt><big>(</big><em>target=None</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.WriteNoStop" title="Permalink to this definition">¶</a></dt>
<dd><p>A callable writer for reports that have been matched to a stop.
This creates a CSV-format file attributes from
<a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a>, and
<a class="reference internal" href="#caravel.transit_system.Stop" title="caravel.transit_system.Stop"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Stop</span></tt></a>.</p>
<p>How to create an object usable a callback with <a class="reference internal" href="#caravel.arrival_at_stop.arrival_at_stop" title="caravel.arrival_at_stop.arrival_at_stop"><tt class="xref py py-func docutils literal"><span class="pre">arrival_at_stop()</span></tt></a>.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">args</span><span class="o">.</span><span class="n">reject</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">no_stop_file</span><span class="p">:</span>
    <span class="n">no_stop</span><span class="o">=</span> <span class="n">NoStop</span><span class="p">(</span> <span class="n">no_stop_file</span> <span class="p">)</span>
</pre></div>
</div>
<p>This creates a callable <tt class="docutils literal"><span class="pre">no_stop</span></tt> function.</p>
<dl class="method">
<dt id="caravel.arrival_at_stop.WriteNoStop.__call__">
<tt class="descname">__call__</tt><big>(</big><em>status</em>, <em>report</em>, <em>dist_fit=None</em>, <em>time_fit=None</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.WriteNoStop.__call__" title="Permalink to this definition">¶</a></dt>
<dd><p>Write a row to the no-stop file.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>message</strong> &#8211; Short string explanation</li>
<li><strong>report</strong> &#8211; <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a> object</li>
<li><strong>candidate_1</strong> &#8211; <a class="reference internal" href="#caravel.transit_system.Stop" title="caravel.transit_system.Stop"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Stop</span></tt></a> object or <tt class="docutils literal"><span class="pre">None</span></tt></li>
<li><strong>candidate_2</strong> &#8211; <a class="reference internal" href="#caravel.transit_system.Stop" title="caravel.transit_system.Stop"><tt class="xref py py-class docutils literal"><span class="pre">caravel.transit_system.Stop</span></tt></a> object or <tt class="docutils literal"><span class="pre">None</span></tt></li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.arrival_at_stop.WriteNoStop.__init__">
<tt class="descname">__init__</tt><big>(</big><em>target=None</em><big>)</big><a class="headerlink" href="#caravel.arrival_at_stop.WriteNoStop.__init__" title="Permalink to this definition">¶</a></dt>
<dd><p>Create the CSV writer around the target file.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>target</strong> &#8211; file-like object suitable to CSV writer.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="caravel.arrival_at_stop.get_args">
<tt class="descclassname">caravel.arrival_at_stop.</tt><tt class="descname">get_args</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/caravel/arrival_at_stop.html#get_args"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.arrival_at_stop.get_args" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse command-line arguments.
:returns: Arguments object.</p>
</dd></dl>

</div></blockquote>
</div>
<div class="section" id="module-caravel.stop_discovery">
<span id="stop-discovery"></span><h3>Stop Discovery<a class="headerlink" href="#module-caravel.stop_discovery" title="Permalink to this headline">¶</a></h3>
<p>Statistical route and stop discovery from location reports.</p>
<p>Synopsis</p>
<div class="highlight-python"><pre>python2.7 -m caravel.stop_discovery source...</pre>
</div>
<p>Description</p>
<blockquote>
<div>For each source file, filter the invalid Reports.  Summarize the
Arrival and Dwell reports.</div></blockquote>
<p>Options</p>
<blockquote>
<div><dl class="option">
<dt id="cmdoption-stop_discovery--debug">
<tt class="descname">--debug</tt><tt class="descclassname"></tt><tt class="descclassname">, </tt><tt class="descname">-d</tt><tt class="descclassname"></tt><a class="headerlink" href="#cmdoption-stop_discovery--debug" title="Permalink to this definition">¶</a></dt>
<dd><p>Set logging level.</p>
</dd></dl>

<dl class="option">
<dt id="cmdoption-stop_discovery--format">
<tt class="descname">--format</tt><tt class="descclassname"> number</tt><a class="headerlink" href="#cmdoption-stop_discovery--format" title="Permalink to this definition">¶</a></dt>
<dd><p>Format number.  Generally maps to a subclass of <a class="reference internal" href="#caravel.report.ReportReader" title="caravel.report.ReportReader"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.ReportReader</span></tt></a>.</p>
</dd></dl>

<dl class="option">
<dt>
<tt class="descname">source...</tt></dt>
<dd><p>List of source files to process.</p>
</dd></dl>

</div></blockquote>
<p>Components</p>
<blockquote>
<div><dl class="function">
<dt id="caravel.stop_discovery.group_by_rte_dir_stop">
<tt class="descclassname">caravel.stop_discovery.</tt><tt class="descname">group_by_rte_dir_stop</tt><big>(</big><em>report_iter</em><big>)</big><a class="reference internal" href="../_modules/caravel/stop_discovery.html#group_by_rte_dir_stop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.stop_discovery.group_by_rte_dir_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Accumulate stops from a sequence of Arrivals.</p>
<p>Generally, the report_iter is an instance of <a class="reference internal" href="#caravel.report.report_file_iter" title="caravel.report.report_file_iter"><tt class="xref py py-func docutils literal"><span class="pre">caravel.report.report_file_iter()</span></tt></a>.</p>
<p>It&#8217;s usually built like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">reader</span><span class="o">=</span> <span class="n">caravel</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">ReportReader_v1</span><span class="p">()</span>
<span class="n">rpt_iter</span><span class="o">=</span> <span class="n">caravel</span><span class="o">.</span><span class="n">report</span><span class="o">.</span><span class="n">report_file_iter</span><span class="p">(</span> <span class="n">reader</span><span class="p">,</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span><span class="n">of</span><span class="p">,</span><span class="n">files</span><span class="p">]</span> <span class="p">)</span>
</pre></div>
</div>
<p>This iterator will examine all the files in the list, extracting
all Report objects.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>report_iter</strong> &#8211; an iterator over <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a> instances.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">two values: (counts, route).  The counts is a dictinary of input, excluded, invalid
and arrivals actually processed.
The route is an OrderedDict, keyed by Route/Dir/Stop with sequence of arrival times.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.stop_discovery.display">
<tt class="descclassname">caravel.stop_discovery.</tt><tt class="descname">display</tt><big>(</big><em>route_dir</em><big>)</big><a class="reference internal" href="../_modules/caravel/stop_discovery.html#display"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.stop_discovery.display" title="Permalink to this definition">¶</a></dt>
<dd><p>Display the accumulated raw data.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>route_dir</strong> &#8211; OrderedDict, keyed by Route/Dir/Stop with sequence of arrival times.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.stop_discovery.get_args">
<tt class="descclassname">caravel.stop_discovery.</tt><tt class="descname">get_args</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/caravel/stop_discovery.html#get_args"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.stop_discovery.get_args" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse command-line arguments.
:returns: Arguments object.</p>
</dd></dl>

</div></blockquote>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../caravel.html">
              <img class="logo" src="../_static/Caravel2_(PSF).png" alt="Logo"/>
            </a></p>
  <h3><a href="../caravel.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Domain Model Implementation</a><ul>
<li><a class="reference internal" href="#extract-transform-load">Extract-Transform-Load</a><ul>
<li><a class="reference internal" href="#module-caravel.LogCapture.acquire">LogCapture</a></li>
<li><a class="reference internal" href="#module-caravel.feed">Feed</a></li>
<li><a class="reference internal" href="#module-caravel.report">Report</a><ul>
<li><a class="reference internal" href="#report-objects">Report Objects</a></li>
<li><a class="reference internal" href="#report-factory">Report Factory</a></li>
<li><a class="reference internal" href="#json-codec">JSON Codec</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-caravel.admin">Administrative Functions</a></li>
</ul>
</li>
<li><a class="reference internal" href="#current-status">Current Status</a><ul>
<li><a class="reference internal" href="#status-builder">Status Builder</a><ul>
<li><a class="reference internal" href="#overall-control">Overall Control</a></li>
<li><a class="reference internal" href="#recursion-detection">Recursion Detection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id1">Feed</a><ul>
<li><a class="reference internal" href="#load-new-mappings">Load New Mappings</a></li>
<li><a class="reference internal" href="#components">Components</a><ul>
<li><a class="reference internal" href="#attachment-handling">Attachment Handling</a></li>
<li><a class="reference internal" href="#mapping-processing">Mapping Processing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#load-new-feeds">Load New Feeds</a></li>
<li><a class="reference internal" href="#id2">Components</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-caravel.status.models">Status</a><ul>
<li><a class="reference internal" href="#id3">Components</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-caravel.transit_system">Transit System</a><ul>
<li><a class="reference internal" href="#acquisition">Acquisition</a></li>
<li><a class="reference internal" href="#transit-objects">Transit Objects</a></li>
<li><a class="reference internal" href="#transit-connection">Transit &#8220;Connection&#8221;</a></li>
<li><a class="reference internal" href="#query-functions">Query Functions</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#analysis-and-profiling">Analysis and Profiling</a><ul>
<li><a class="reference internal" href="#module-caravel.statistics">Statistics</a></li>
<li><a class="reference internal" href="#module-caravel.arrival_stats">Arrival Statistics</a></li>
<li><a class="reference internal" href="#module-caravel.transit_stats">Transit System Statistics</a></li>
</ul>
</li>
<li><a class="reference internal" href="#applications">Applications</a><ul>
<li><a class="reference internal" href="#module-caravel.arrival_at_stop">Arrival At Stop</a></li>
<li><a class="reference internal" href="#module-caravel.stop_discovery">Stop Discovery</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="database.html"
                        title="previous chapter">Database Implementation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="web.html"
                        title="next chapter">Web Implementation</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/implementation/domain.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="web.html" title="Web Implementation"
             >next</a> |</li>
        <li class="right" >
          <a href="database.html" title="Database Implementation"
             >previous</a> |</li>
        <li><a href="../caravel.html">Caravel-Transit 1.1 documentation</a> &raquo;</li>
          <li><a href="index.html" >Implementation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, S.Lott.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>