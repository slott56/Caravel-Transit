
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Domain Model Implementation &mdash; Caravel-Transit 1.2 documentation</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Caravel-Transit 1.2 documentation" href="../index.html" />
    <link rel="up" title="Implementation" href="index.html" />
    <link rel="next" title="Extract Transform and Load" href="etl.html" />
    <link rel="prev" title="Database Implementation" href="database.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="etl.html" title="Extract Transform and Load"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="database.html" title="Database Implementation"
             accesskey="P">previous</a> |</li>
        <li><a href="../caravel.html">Caravel-Transit 1.2 documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Implementation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="domain-model-implementation">
<h1>Domain Model Implementation<a class="headerlink" href="#domain-model-implementation" title="Permalink to this headline">¶</a></h1>
<p>The problem domain includes objects of the following broad subject areas.</p>
<ul class="simple">
<li><a class="reference internal" href="#feed">Feed</a> includes the real-time Spysocket.log data
and the  mappings between the real-time feed and GTF transit system.</li>
<li><a class="reference internal" href="#report">Report</a> are the real-time position reports.</li>
<li><a class="reference internal" href="#transit-system">Transit System</a> contains the GTF transit system description.</li>
<li><a class="reference internal" href="#status">Status</a> contains the final reports on vehicles, routes and stops.</li>
</ul>
<div class="section" id="feed">
<h2>Feed<a class="headerlink" href="#feed" title="Permalink to this headline">¶</a></h2>
<p>The raw data includes mappings and position feeds.</p>
<div class="section" id="module-caravel.feed.mapping_load">
<span id="mapping-load"></span><h3>Mapping Load<a class="headerlink" href="#module-caravel.feed.mapping_load" title="Permalink to this headline">¶</a></h3>
<p>Caravel ETL of real-time-feed with mappings
from source encodings to GTFS keys.</p>
<ol class="arabic simple">
<li>Get any new mapping.</li>
<li>Validate the mapping.<ul>
<li>Check the timestamp and delete duplicates (same type,
same effective date, same or older timestamp).</li>
<li>Check the type.</li>
<li>Check the attachment size and structure.</li>
</ul>
</li>
<li>Put in a proper effective date range.</li>
<li>Cache the current mapping chosen from the set of valid mappings.
It&#8217;s helpful to keep this in memory to save time.</li>
</ol>
<div class="section" id="attachment-handling">
<h4>Attachment Handling<a class="headerlink" href="#attachment-handling" title="Permalink to this headline">¶</a></h4>
<dl class="class">
<dt id="caravel.feed.mapping_load.Invalid_Mapping">
<em class="property">class </em><tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">Invalid_Mapping</tt><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#Invalid_Mapping"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.Invalid_Mapping" title="Permalink to this definition">¶</a></dt>
<dd><p>An exception raised as part of mapping validation.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.feed.mapping_load.CSV_Attachment">
<em class="property">class </em><tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">CSV_Attachment</tt><big>(</big><em>document</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#CSV_Attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.CSV_Attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>The attached file for a mapping.  The file should be a .CSV notation
file with two specific column names.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.feed.mapping_load.Vehicle_Attachment">
<em class="property">class </em><tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">Vehicle_Attachment</tt><big>(</big><em>document</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#Vehicle_Attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.Vehicle_Attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="#caravel.feed.mapping_load.CSV_Attachment" title="caravel.feed.mapping_load.CSV_Attachment"><tt class="xref py py-class docutils literal"><span class="pre">CSV_Attachment</span></tt></a> for the vehicle mapping.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.feed.mapping_load.Route_Attachment">
<em class="property">class </em><tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">Route_Attachment</tt><big>(</big><em>document</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#Route_Attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.Route_Attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="#caravel.feed.mapping_load.CSV_Attachment" title="caravel.feed.mapping_load.CSV_Attachment"><tt class="xref py py-class docutils literal"><span class="pre">CSV_Attachment</span></tt></a> for the route mapping.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.feed.mapping_load.Stop_Attachment">
<em class="property">class </em><tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">Stop_Attachment</tt><big>(</big><em>document</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#Stop_Attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.Stop_Attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>A <a class="reference internal" href="#caravel.feed.mapping_load.CSV_Attachment" title="caravel.feed.mapping_load.CSV_Attachment"><tt class="xref py py-class docutils literal"><span class="pre">CSV_Attachment</span></tt></a> for the stop id mapping.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.mapping_load.mapping_attachment">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">mapping_attachment</tt><big>(</big><em>mapping</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#mapping_attachment"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.mapping_attachment" title="Permalink to this definition">¶</a></dt>
<dd><p>Instantiate the proper CSV_Attachment subclass
for this mapping.</p>
</dd></dl>

</div>
<div class="section" id="mapping-processing">
<h4>Mapping Processing<a class="headerlink" href="#mapping-processing" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="caravel.feed.mapping_load.validate">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">validate</tt><big>(</big><em>mapping</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#validate"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.validate" title="Permalink to this definition">¶</a></dt>
<dd><p>Validate a given mapping object.  This will locate
an appropriate attachment handler and then invoke the attachment
handler&#8217;s <tt class="xref py py-meth docutils literal"><span class="pre">CSV_Attachment.validate()</span></tt> method.</p>
<p>This is the first step when processing a new mapping.</p>
<p>If anything goes wrong an exception is raised.
Otherwise this returns the mapping.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.mapping_load.validate_new">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">validate_new</tt><big>(</big><em>mapping_iter</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#validate_new"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.validate_new" title="Permalink to this definition">¶</a></dt>
<dd><p>For all new mappings, validate the attached content and update
the status to mark them as usable.</p>
<p>Return a dictionary of sequences of the new mappings which are also valid.
The keys are the mapping types.  The value is a sequence of valid
mappings of that type.
This return value signals that we must rework the timeline
and reload the mappings that are in cache.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.mapping_load.assemble_timeline">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">assemble_timeline</tt><big>(</big><em>mapping_type</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#assemble_timeline"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.assemble_timeline" title="Permalink to this definition">¶</a></dt>
<dd><p>For all valid mappings, reassemble the timeline for each type.</p>
<p>This is the sequence of valid mappings in order by their
effective_date from most recent to oldest.</p>
<p>The most recent applies until the end of time.
Each previous mapping applies until the one more recently added.
Generally, just the last two mappings need to be tweaked to have
proper ending dates.  As a simplification, we reset all
ending dates to assure consistent data.</p>
<p>Returns the sequence of mappings of the given type.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.mapping_load.fetch_current">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">fetch_current</tt><big>(</big><em>mapping_type</em>, <em>today</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#fetch_current"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.fetch_current" title="Permalink to this definition">¶</a></dt>
<dd><p>Locate the mapping of the given type which is active today.
This requires that mappings are all validated and the timeline
has been assembled correctly.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.mapping_load.refresh_mapping_cache">
<tt class="descclassname">caravel.feed.mapping_load.</tt><tt class="descname">refresh_mapping_cache</tt><big>(</big><em>mapping_cache</em>, <em>new_mappings=None</em>, <em>today=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/mapping_load.html#refresh_mapping_cache"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.mapping_load.refresh_mapping_cache" title="Permalink to this definition">¶</a></dt>
<dd><p>Locate the current mappings so they can be cached and used.</p>
<ol class="arabic simple">
<li>Validate all new mappings.
This uses <a class="reference internal" href="#caravel.feed.mapping_load.validate_new" title="caravel.feed.mapping_load.validate_new"><tt class="xref py py-func docutils literal"><span class="pre">validate_new()</span></tt></a>.</li>
<li>Among the valid maps, reason out the timeline and make
sure the effective_dates and ending_dates all make sense.
This uses <a class="reference internal" href="#caravel.feed.mapping_load.assemble_timeline" title="caravel.feed.mapping_load.assemble_timeline"><tt class="xref py py-func docutils literal"><span class="pre">assemble_timeline()</span></tt></a>.</li>
<li>Pick the mappings that apply today.
This uses <a class="reference internal" href="#caravel.feed.mapping_load.fetch_current" title="caravel.feed.mapping_load.fetch_current"><tt class="xref py py-func docutils literal"><span class="pre">fetch_current()</span></tt></a>.</li>
<li>Compare with the mappings in the local mappings cache.
If the current mapping is new, then parse the CSV mapping data.
If the current mapping hasn&#8217;t changed, then we&#8217;re good.</li>
</ol>
<p>This must be run based on two events.</p>
<ul class="simple">
<li>Beginning of each day.</li>
<li>Each time a mapping is pushed.</li>
</ul>
<p>It can be run before each feed is processed, but that&#8217;s a bit more
processing than is strictly necessary.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">dictionary with &#8216;vehicle&#8217;, &#8216;route&#8217;, &#8216;stop&#8217; mappings.</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
<div class="section" id="module-caravel.feed.feed_load">
<span id="feed-load"></span><h3>Feed Load<a class="headerlink" href="#module-caravel.feed.feed_load" title="Permalink to this headline">¶</a></h3>
<p>Caravel ETL of real-time-feed with mappings
from source encodings to GTFS keys.</p>
<ol class="arabic">
<li><p class="first">Get the next unprocessed feed.</p>
<ul class="simple">
<li>Discard unreadable feeds.</li>
<li>Discard feeds with improper headings.</li>
</ul>
</li>
<li><p class="first">Apply the mapping;
create the sequence of position reports.
It&#8217;s not essential to persist the position reports.</p>
<p>The LogTail application uses the following headings for a feed.</p>
<div class="highlight-python"><pre>String[] headings = {
    "Date", "Time", "Vehicle", "Lat", "Lon", "Location Valid/Invalid",
    "Adherence", "Adherence Valid/Invalid", "Route", "Direction", "Stop"
};</pre>
</div>
</li>
<li><p class="first">Clean up old feeds.</p>
</li>
</ol>
<div class="section" id="components">
<h4>Components<a class="headerlink" href="#components" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="caravel.feed.feed_load.remove_damaged">
<tt class="descclassname">caravel.feed.feed_load.</tt><tt class="descname">remove_damaged</tt><big>(</big><em>db</em>, <em>feed_iter</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/feed_load.html#remove_damaged"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.feed_load.remove_damaged" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove feed documents which are so damaged we can&#8217;t map them
to Python objects.</p>
<p>This is rare, and usually comes from poor unit testing on LogTail.</p>
<p>Once in a while, something can go horribly wrong and the
query needs to be changed to &#8220;feed/all&#8221; to check all feeds
instead of &#8220;feed/new&#8221;.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">sequence of {id:..., rev:..., ok:true} status responses.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.feed_load.remove_old">
<tt class="descclassname">caravel.feed.feed_load.</tt><tt class="descname">remove_old</tt><big>(</big><em>db</em>, <em>today=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/feed_load.html#remove_old"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.feed_load.remove_old" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove old feed documents that we&#8217;ve processed.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">sequence of {id:..., rev:..., ok:true} status responses.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.feed_load.new_feed_iter">
<tt class="descclassname">caravel.feed.feed_load.</tt><tt class="descname">new_feed_iter</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/caravel/feed/feed_load.html#new_feed_iter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.feed_load.new_feed_iter" title="Permalink to this definition">¶</a></dt>
<dd><p>Query all real-time Feed uploads.
Do a validation to assure that</p>
<ol class="loweralpha simple">
<li>we can build a Feed object,</li>
<li>there&#8217;s a proper attachment.</li>
</ol>
</dd></dl>

<dl class="function">
<dt id="caravel.feed.feed_load.transform_new">
<tt class="descclassname">caravel.feed.feed_load.</tt><tt class="descname">transform_new</tt><big>(</big><em>mappings</em>, <em>feed_iter</em>, <em>track_arrival</em>, <em>track_location</em>, <em>today=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/feed/feed_load.html#transform_new"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.feed.feed_load.transform_new" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</div>
</div>
</div>
<div class="section" id="report">
<h2>Report<a class="headerlink" href="#report" title="Permalink to this headline">¶</a></h2>
<p>An intermediate position report can be built from the raw
position feed.</p>
<span class="target" id="module-caravel.report"></span><p>Caravel Report object definitions.</p>
<p>This reads one (or more) raw files (or file-like CouchDB Attachments)
and creates a sequence of Report instances.  The subclasses include</p>
<ul class="simple">
<li>Location - a simple location report; rte is None and dwell is None.</li>
<li>Dwell - a Report with route/direction/stop and dwell time;
rte is not None and dwell is not None.</li>
<li>Arrival - a Report with route/direction/stop arrived instead of dwell time
rte is not None and dwell is None.</li>
</ul>
<p>The fourth possible combination (rte is None and dwell is not None) cannot occur.</p>
<div class="section" id="report-objects">
<h3>Report Objects<a class="headerlink" href="#report-objects" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="caravel.report.Report">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">Report</tt><big>(</big><em>_d=None</em>, <em>**kwargs</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#Report"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.Report" title="Permalink to this definition">¶</a></dt>
<dd><p>Abstract superclass of the various kinds of reports.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.report.Location">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">Location</tt><big>(</big><em>_d=None</em>, <em>**kwargs</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#Location"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.Location" title="Permalink to this definition">¶</a></dt>
<dd><p>A Location report for a Vehicle in motion.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.report.Arrival">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">Arrival</tt><big>(</big><em>_d=None</em>, <em>**kwargs</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#Arrival"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.Arrival" title="Permalink to this definition">¶</a></dt>
<dd><p>A Location report for a Vehicle arriving at a stop.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.report.Dwell">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">Dwell</tt><big>(</big><em>_d=None</em>, <em>**kwargs</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#Dwell"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.Dwell" title="Permalink to this definition">¶</a></dt>
<dd><p>A Location report for a Vehicle paused at a stop.
This is less helpful and may get filtered out.</p>
</dd></dl>

</div>
<div class="section" id="report-factory">
<h3>Report Factory<a class="headerlink" href="#report-factory" title="Permalink to this headline">¶</a></h3>
<dl class="class">
<dt id="caravel.report.ReportReader">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">ReportReader</tt><big>(</big><em>year=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader" title="Permalink to this definition">¶</a></dt>
<dd><p>An abstract iterator over Report items (<a class="reference internal" href="#caravel.report.Location" title="caravel.report.Location"><tt class="xref py py-class docutils literal"><span class="pre">Location</span></tt></a>, <a class="reference internal" href="#caravel.report.Arrival" title="caravel.report.Arrival"><tt class="xref py py-class docutils literal"><span class="pre">Arrival</span></tt></a>, <a class="reference internal" href="#caravel.report.Dwell" title="caravel.report.Dwell"><tt class="xref py py-class docutils literal"><span class="pre">Dwell</span></tt></a>).</p>
<p>This is the abstract superclass for various reader implementations.</p>
<p>Requires <a class="reference internal" href="#caravel.report.ReportReader.open" title="caravel.report.ReportReader.open"><tt class="xref py py-meth docutils literal"><span class="pre">ReportReader.open()</span></tt></a>
and <a class="reference internal" href="#caravel.report.ReportReader.factory" title="caravel.report.ReportReader.factory"><tt class="xref py py-meth docutils literal"><span class="pre">ReportReader.factory()</span></tt></a>.</p>
<dl class="method">
<dt id="caravel.report.ReportReader.__init__">
<tt class="descname">__init__</tt><big>(</big><em>year=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader.__init__"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader.__init__" title="Permalink to this definition">¶</a></dt>
<dd><p>Build a ReportReader_v1 with a given default year.</p>
<p>The year is required because the timestamps only have month and day.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>year</strong> &#8211; Year extracted from file name.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader.__iter__">
<tt class="descname">__iter__</tt><big>(</big><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader.__iter__"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader.__iter__" title="Permalink to this definition">¶</a></dt>
<dd><p>Iterate over Report instances in this source.</p>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader.factory">
<tt class="descname">factory</tt><big>(</big><em>line</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader.factory"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader.factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the fields, returning Arrival, Dwell or Location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>line</strong> &#8211; line of raw input.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Report instance, if possible.  <tt class="docutils literal"><span class="pre">None</span></tt> if the fields can&#8217;t be parsed.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader.open">
<tt class="descname">open</tt><big>(</big><em>source</em>, <em>year=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader.open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a given source for processing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>source</strong> &#8211; an open file-like source.</li>
<li><strong>year</strong> &#8211; a potential override for the default year.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.report.ReportReader_v1">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">ReportReader_v1</tt><big>(</big><em>year=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v1"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v1" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterator over Report items (<a class="reference internal" href="#caravel.report.Location" title="caravel.report.Location"><tt class="xref py py-class docutils literal"><span class="pre">Location</span></tt></a>, <a class="reference internal" href="#caravel.report.Arrival" title="caravel.report.Arrival"><tt class="xref py py-class docutils literal"><span class="pre">Arrival</span></tt></a>, <a class="reference internal" href="#caravel.report.Dwell" title="caravel.report.Dwell"><tt class="xref py py-class docutils literal"><span class="pre">Dwell</span></tt></a>).</p>
<p>This handles V1 format, with space-delimited fields in the following form.</p>
<div class="highlight-python"><pre>07:04:42 02/15  V.1.2233  H.0.0  MT_LOCATION    Lat/Lon:370620935/-763413842 [Valid]  Adher:-1 [Valid]  Odom:2668 [Valid]  DGPS:On  FOM:2</pre>
</div>
<p>This is an iterable object, generally something like the following is done:</p>
<div class="highlight-python"><pre>reader= ReportReader_v1()
with open(some_file) as source:
    reader.open(some_file)
    for report in reader:
        # process report</pre>
</div>
<dl class="method">
<dt id="caravel.report.ReportReader_v1.common_fields">
<tt class="descname">common_fields</tt><big>(</big><em>fields</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v1.common_fields"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v1.common_fields" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the common set of fields.
These are Fields 13-20 of MT_TIMEPOINTCROSSING.
They are also Fields 5-12 of MT_LOCATION.</p>
<p>These fields are</p>
<ul class="simple">
<li>&#8220;Lat/Lon&#8221; and the following &#8220;[Valid]&#8221;/&#8221;[Invalid]&#8221; flag.</li>
<li>&#8220;Adher&#8221; and the following &#8220;[Valid]&#8221;/&#8221;[Invalid]&#8221; flag.</li>
<li>&#8220;Odom&#8221; and the following &#8220;[Valid]&#8221;/&#8221;[Invalid]&#8221; flag.</li>
<li>&#8220;DGPS&#8221;</li>
<li>&#8220;FOM&#8221;</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">tuple of (lat, lon, ll_valid, adher, adher_valid, odom, odom_valid, dgps, fom)</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.factory">
<tt class="descname">factory</tt><big>(</big><em>line</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v1.factory"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v1.factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the fields, returning Arrival, Dwell or Location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>line</strong> &#8211; line of raw input.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Report instance, if possible.  <tt class="docutils literal"><span class="pre">None</span></tt> if the fields can&#8217;t be parsed.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.label_int">
<tt class="descname">label_int</tt><big>(</big><em>field</em>, <em>expected</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v1.label_int"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v1.label_int" title="Permalink to this definition">¶</a></dt>
<dd><p>Split a &#8220;label:value&#8221; field, attempting an integer conversion.
If the label is not as expected, raise an exception.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>field</strong> &#8211; a &#8220;label:value field</li>
<li><strong>expected</strong> &#8211; the expected label.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">the integer value</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.label_lat_lon">
<tt class="descname">label_lat_lon</tt><big>(</big><em>field</em>, <em>expected='Lat/Lon'</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v1.label_lat_lon"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v1.label_lat_lon" title="Permalink to this definition">¶</a></dt>
<dd><p>Split a &#8220;label:lat/lon&#8221; field, attempting an fairly complex conversion.
If the label is not as expected, raise an exception.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>field</strong> &#8211; a &#8220;label:lat/lon field</li>
<li><strong>expected</strong> &#8211; the expected label.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">(lat, lon) 2-tuple</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.label_str">
<tt class="descname">label_str</tt><big>(</big><em>field</em>, <em>expected</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v1.label_str"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v1.label_str" title="Permalink to this definition">¶</a></dt>
<dd><p>Split a &#8220;label:value&#8221; field, doing no further conversion.
If the label is not as expected, raise an exception.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>field</strong> &#8211; a &#8220;label:value field</li>
<li><strong>expected</strong> &#8211; the expected label.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">the string value</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.label_time">
<tt class="descname">label_time</tt><big>(</big><em>field</em>, <em>expected</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v1.label_time"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v1.label_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Split a &#8220;label:time&#8221; field, to create a seconds-after-midnight value.
If the label is not as expected, raise an exception.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>field</strong> &#8211; a &#8220;label:time field</li>
<li><strong>expected</strong> &#8211; the expected label.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">datetime.time() object.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v1.open">
<tt class="descname">open</tt><big>(</big><em>source</em>, <em>year=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v1.open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v1.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a given source for processing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>source</strong> &#8211; an open file-like source.</li>
<li><strong>year</strong> &#8211; a potential override for the default year.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="attribute">
<dt id="caravel.report.ReportReader_v1.vehicle_pat">
<tt class="descname">vehicle_pat</tt><em class="property"> = &lt;_sre.SRE_Pattern object at 0x103c28030&gt;</em><a class="headerlink" href="#caravel.report.ReportReader_v1.vehicle_pat" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.report.ReportReader_v21">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">ReportReader_v21</tt><big>(</big><em>year=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v21"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v21" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterator over Report items (<a class="reference internal" href="#caravel.report.Location" title="caravel.report.Location"><tt class="xref py py-class docutils literal"><span class="pre">Location</span></tt></a>, <a class="reference internal" href="#caravel.report.Arrival" title="caravel.report.Arrival"><tt class="xref py py-class docutils literal"><span class="pre">Arrival</span></tt></a>, <a class="reference internal" href="#caravel.report.Dwell" title="caravel.report.Dwell"><tt class="xref py py-class docutils literal"><span class="pre">Dwell</span></tt></a>).</p>
<p>This handles V2.1 format, which is CSV and includes Route ID.</p>
<p>First Line:</p>
<div class="highlight-python"><pre>Time,Date,RID,Lat/Lon,Location Valid/Invalid,Adherence,Adherence Valid/Invalid[,Route,Direction,StopID]</pre>
</div>
<p>Column Titles:</p>
<blockquote>
<div><ul class="simple">
<li>&#8216;Time&#8217;</li>
<li>&#8216;Date&#8217;</li>
<li>&#8216;RID&#8217;</li>
<li>&#8216;Lat/Lon&#8217;</li>
<li>&#8216;Location Valid/Invalid&#8217;</li>
<li>&#8216;Adherence&#8217;</li>
<li>&#8216;Adherence Valid/Invalid[&#8216; # Really.</li>
<li>&#8216;Route&#8217;</li>
<li>&#8216;Direction&#8217;</li>
<li>&#8216;StopID]&#8217; # Also peculiar.</li>
</ul>
</div></blockquote>
<p>This is an iterable object, generally something like the following is done:</p>
<div class="highlight-python"><pre>reader= ReportReader_v2()
with open(some_file) as source:
    reader.open(some_file)
    for report in reader:
        # process report</pre>
</div>
<dl class="method">
<dt id="caravel.report.ReportReader_v21.factory">
<tt class="descname">factory</tt><big>(</big><em>line</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v21.factory"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v21.factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the fields, returning Arrival, Dwell or Location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>line</strong> &#8211; CSV line of raw input.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Report instance, if possible.  <tt class="docutils literal"><span class="pre">None</span></tt> if the fields can&#8217;t be parsed.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v21.open">
<tt class="descname">open</tt><big>(</big><em>source</em>, <em>year=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v21.open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v21.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a given source for processing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>source</strong> &#8211; an open file-like source.</li>
<li><strong>year</strong> &#8211; a potential override for the default year.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.report.ReportReader_v22">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">ReportReader_v22</tt><big>(</big><em>year=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v22"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v22" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterator over Report items (<a class="reference internal" href="#caravel.report.Location" title="caravel.report.Location"><tt class="xref py py-class docutils literal"><span class="pre">Location</span></tt></a>, <a class="reference internal" href="#caravel.report.Arrival" title="caravel.report.Arrival"><tt class="xref py py-class docutils literal"><span class="pre">Arrival</span></tt></a>, <a class="reference internal" href="#caravel.report.Dwell" title="caravel.report.Dwell"><tt class="xref py py-class docutils literal"><span class="pre">Dwell</span></tt></a>).</p>
<p>This handles V2.2 format, which is CSV and includes Vehicle ID</p>
<p>First Line:</p>
<div class="highlight-python"><pre>Time,Date,Vehicle,Lat/Lon,Location Valid/Invalid,Adherence,Adherence Valid/Invalid[,Route,Direction,StopID]</pre>
</div>
<p>Column Titles:</p>
<blockquote>
<div><ul class="simple">
<li>&#8216;Time&#8217;</li>
<li>&#8216;Date&#8217;</li>
<li>&#8216;Vehicle&#8217;</li>
<li>&#8216;Lat/Lon&#8217;</li>
<li>&#8216;Location Valid/Invalid&#8217;</li>
<li>&#8216;Adherence&#8217;</li>
<li>&#8216;Adherence Valid/Invalid[&#8216; # Really.</li>
<li>&#8216;Route&#8217;</li>
<li>&#8216;Direction&#8217;</li>
<li>&#8216;Stop]&#8217; # Also peculiar.</li>
</ul>
</div></blockquote>
<p>This is an iterable object, generally something like the following is done:</p>
<div class="highlight-python"><pre>reader= ReportReader_v3()
with open(some_file) as source:
    reader.open(some_file)
    for report in reader:
        # process report</pre>
</div>
<dl class="method">
<dt id="caravel.report.ReportReader_v22.factory">
<tt class="descname">factory</tt><big>(</big><em>line</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v22.factory"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v22.factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the fields, returning Arrival, Dwell or Location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>line</strong> &#8211; CSV line of raw input.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Report instance, if possible.  <tt class="docutils literal"><span class="pre">None</span></tt> if the fields can&#8217;t be parsed.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.report.ReportReader_v3">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">ReportReader_v3</tt><big>(</big><em>year=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v3"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v3" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterator over Report items (<a class="reference internal" href="#caravel.report.Location" title="caravel.report.Location"><tt class="xref py py-class docutils literal"><span class="pre">Location</span></tt></a>, <a class="reference internal" href="#caravel.report.Arrival" title="caravel.report.Arrival"><tt class="xref py py-class docutils literal"><span class="pre">Arrival</span></tt></a>, <a class="reference internal" href="#caravel.report.Dwell" title="caravel.report.Dwell"><tt class="xref py py-class docutils literal"><span class="pre">Dwell</span></tt></a>).</p>
<p>This handles V3 format, which is CSV.</p>
<p>Source:</p>
<div class="highlight-python"><pre>String[] headings = {
    "Date", "Time", "Vehicle", "Lat", "Lon", "Location Valid/Invalid",
    "Adherence", "Adherence Valid/Invalid", "Route", "Direction", "Stop"
};</pre>
</div>
<p>Column Titles:</p>
<blockquote>
<div><ul class="simple">
<li>&#8216;Date&#8217;</li>
<li>&#8216;Time&#8217;</li>
<li>&#8216;Vehicle&#8217;</li>
<li>&#8216;Lat&#8217;</li>
<li>&#8216;Lon&#8217;</li>
<li>&#8216;Location Valid/Invalid&#8217;</li>
<li>&#8216;Adherence&#8217;</li>
<li>&#8216;Adherence Valid/Invalid&#8217;</li>
<li>&#8216;Route&#8217;</li>
<li>&#8216;Direction&#8217;</li>
<li>&#8216;Stop&#8217;</li>
</ul>
</div></blockquote>
<p>This is an iterable object, generally something like the following is done:</p>
<div class="highlight-python"><pre>reader= ReportReader_v3()
with open(some_file) as source:
    reader.open(some_file)
    for report in reader:
        # process report</pre>
</div>
<dl class="method">
<dt id="caravel.report.ReportReader_v3.factory">
<tt class="descname">factory</tt><big>(</big><em>line</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v3.factory"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v3.factory" title="Permalink to this definition">¶</a></dt>
<dd><p>Parse the fields, returning Arrival, Dwell or Location.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>line</strong> &#8211; CSV line of raw input.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">Report instance, if possible.  <tt class="docutils literal"><span class="pre">None</span></tt> if the fields can&#8217;t be parsed.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="method">
<dt id="caravel.report.ReportReader_v3.open">
<tt class="descname">open</tt><big>(</big><em>source</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#ReportReader_v3.open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.ReportReader_v3.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Open a given source for processing.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>source</strong> &#8211; an open file-like source.</td>
</tr>
</tbody>
</table>
</dd></dl>

</dd></dl>

<dl class="function">
<dt id="caravel.report.report_file_iter">
<tt class="descclassname">caravel.report.</tt><tt class="descname">report_file_iter</tt><big>(</big><em>report_reader</em>, <em>files</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#report_file_iter"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.report_file_iter" title="Permalink to this definition">¶</a></dt>
<dd><p>An iterator which applies the <tt class="docutils literal"><span class="pre">report_reader</span></tt> instance to all
of the named files.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>report_reader</strong> &#8211; an instance of <a class="reference internal" href="#caravel.report.ReportReader" title="caravel.report.ReportReader"><tt class="xref py py-class docutils literal"><span class="pre">ReportReader</span></tt></a> which parses
input lines and creates <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">Report</span></tt></a> instances.</li>
<li><strong>files</strong> &#8211; an iterable over the file names.
To process a single file, use <tt class="docutils literal"><span class="pre">report_file_iter(</span> <span class="pre">report_reader,</span> <span class="pre">[one_file]</span> <span class="pre">)</span></tt></li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
<div class="section" id="json-codec">
<h3>JSON Codec<a class="headerlink" href="#json-codec" title="Permalink to this headline">¶</a></h3>
<p>This is not terribly useful, since CouchDB does this for us.</p>
<dl class="class">
<dt id="caravel.report.JSONEncoder">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">JSONEncoder</tt><big>(</big><em>skipkeys=False</em>, <em>ensure_ascii=True</em>, <em>check_circular=True</em>, <em>allow_nan=True</em>, <em>sort_keys=False</em>, <em>indent=None</em>, <em>separators=None</em>, <em>encoding='utf-8'</em>, <em>default=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#JSONEncoder"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.JSONEncoder" title="Permalink to this definition">¶</a></dt>
<dd><p>Encode any of the Report subclasses into JSON.</p>
<p>Not needed, since couchdbkit.schema.Document objects
have a <tt class="xref py py-meth docutils literal"><span class="pre">couchdbkit.schema.Document.to_json()</span></tt> method that
handles some of the conversion.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span> <span class="n">rpt</span><span class="o">.</span><span class="n">to_json</span><span class="p">()</span> <span class="p">)</span>
</pre></div>
</div>
<p>Far better than this.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.report.JSONDecoder">
<em class="property">class </em><tt class="descclassname">caravel.report.</tt><tt class="descname">JSONDecoder</tt><big>(</big><em>*args</em>, <em>**kwargs</em><big>)</big><a class="reference internal" href="../_modules/caravel/report.html#JSONDecoder"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.report.JSONDecoder" title="Permalink to this definition">¶</a></dt>
<dd><p>Decode any of the Report subclasses from JSON.</p>
</dd></dl>

</div>
</div>
<div class="section" id="transit-system">
<h2>Transit System<a class="headerlink" href="#transit-system" title="Permalink to this headline">¶</a></h2>
<p>The current transit system description.</p>
<div class="section" id="module-caravel.transit_system.load">
<span id="transit-system-load"></span><h3>Transit System Load<a class="headerlink" href="#module-caravel.transit_system.load" title="Permalink to this headline">¶</a></h3>
<p>Caravel Transit System Database Load.</p>
<p>This reads the various files that define the transit system to
create a CouchDB database.</p>
<ul class="simple">
<li>calendar.txt</li>
<li>calendar_dates.txt</li>
<li>routes.txt</li>
<li>stops.txt</li>
<li>trips.txt</li>
<li>stop_times.txt</li>
</ul>
<p>Transit System Source</p>
<div class="highlight-python"><pre>http://googletf.gohrt.com/google_transit.zip</pre>
</div>
<div class="section" id="load">
<h4>Load<a class="headerlink" href="#load" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="caravel.transit_system.load.get_source_data">
<tt class="descclassname">caravel.transit_system.load.</tt><tt class="descname">get_source_data</tt><big>(</big><em>connection=None</em>, <em>target_dir='.'</em>, <em>url=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/load.html#get_source_data"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.load.get_source_data" title="Permalink to this definition">¶</a></dt>
<dd><p>Get the lastest Route Definition ZIP Archive.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>connection</strong> &#8211; Override to the default of urllib2.OpenerDirector.</li>
<li><strong>target_dir</strong> &#8211; Working directory for result file</li>
<li><strong>url</strong> &#8211; URL for the file (<a class="reference external" href="http://googletf.gohrt.com/google_transit.zip">http://googletf.gohrt.com/google_transit.zip</a>)</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.load.Accessor">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.load.</tt><tt class="descname">Accessor</tt><a class="reference internal" href="../_modules/caravel/transit_system/load.html#Accessor"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.load.Accessor" title="Permalink to this definition">¶</a></dt>
<dd><p>Abstract superclass to unify access to a directory and access to
a ZIP archive.</p>
</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.load.AccessZip">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.load.</tt><tt class="descname">AccessZip</tt><big>(</big><em>archive</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/load.html#AccessZip"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.load.AccessZip" title="Permalink to this definition">¶</a></dt>
<dd><p>Access a ZIP archive.</p>
<dl class="method">
<dt id="caravel.transit_system.load.AccessZip.open">
<tt class="descname">open</tt><big>(</big><em>name</em>, <em>mode='r'</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/load.html#AccessZip.open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.load.AccessZip.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns an open file object for the named member.</p>
</dd></dl>

</dd></dl>

<dl class="class">
<dt id="caravel.transit_system.load.AccessDir">
<em class="property">class </em><tt class="descclassname">caravel.transit_system.load.</tt><tt class="descname">AccessDir</tt><big>(</big><em>base</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/load.html#AccessDir"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.load.AccessDir" title="Permalink to this definition">¶</a></dt>
<dd><p>Access a Directory (an archive that&#8217;s been expanded.)</p>
<dl class="method">
<dt id="caravel.transit_system.load.AccessDir.open">
<tt class="descname">open</tt><big>(</big><em>name</em>, <em>mode='rb'</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/load.html#AccessDir.open"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.load.AccessDir.open" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns an open file object for the named member.</p>
</dd></dl>

</dd></dl>

</div>
</div>
<div class="section" id="module-caravel.transit_system.query">
<span id="transit-system-query"></span><h3>Transit System Query<a class="headerlink" href="#module-caravel.transit_system.query" title="Permalink to this headline">¶</a></h3>
<p>Caravel Transit System Database Queries.</p>
<div class="section" id="query-functions">
<h4>Query Functions<a class="headerlink" href="#query-functions" title="Permalink to this headline">¶</a></h4>
<dl class="function">
<dt id="caravel.transit_system.query.get_services_today">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_services_today</tt><big>(</big><em>today=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_services_today"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_services_today" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the Service ID applicable today.
Examines calendar and calendar dates.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>today</strong> &#8211; A <tt class="xref py py-class docutils literal"><span class="pre">datetime.date</span></tt> object.
If omitted, the current date is used.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">A sequence of service id strings that apply to this date.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_closest_stops">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_closest_stops</tt><big>(</big><em>lat_lon</em>, <em>max_dist=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_closest_stops"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_closest_stops" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a lat/lon pair, locate nearby stops.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>lat_lon</strong> &#8211; A (lat,lon) 2-tuple</li>
<li><strong>max_dist</strong> &#8211; An upper limit on distances to examine</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterator over (distance,stop) pairs ordered from nearest to
the specified max_dist value.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_closest_times_in_service">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_closest_times_in_service</tt><big>(</big><em>stop_id</em>, <em>time</em>, <em>services</em>, <em>min_time=None</em>, <em>max_time=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_closest_times_in_service"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_closest_times_in_service" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a stop and a time, locate the scheduled stop_time closest to this.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>stop_id</strong> &#8211; The id for a stop</li>
<li><strong>time</strong> &#8211; The seconds-after-midnight time</li>
<li><strong>services</strong> &#8211; The iterable sequence of services applicable</li>
<li><strong>min_time</strong> &#8211; The lower limit on seconds prior to the scheduled time.
Usually, this is a negative number.</li>
<li><strong>max_time</strong> &#8211; The upper limit on seconds after the the scheduled time.
This is a positive number.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterator over (time,stop_time) pairs ordered from closest in time
to the max_time value.  The absolute magnitude is used for sorting
so early and late times will be intermixed.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_candidate_stops">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_candidate_stops</tt><big>(</big><em>lat_lon</em>, <em>time</em>, <em>services</em>, <em>max_dist=None</em>, <em>min_time=None</em>, <em>max_time=None</em>, <em>count=6</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_candidate_stops"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_candidate_stops" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute the most likely stops to match a report&#8217;s lat/lon and time.
This will use <a class="reference internal" href="#caravel.transit_system.query.get_closest_stops" title="caravel.transit_system.query.get_closest_stops"><tt class="xref py py-meth docutils literal"><span class="pre">get_closest_stops()</span></tt></a> to locate a collection of likely stops.
For each stop, <a class="reference internal" href="#caravel.transit_system.query.get_closest_times_in_service" title="caravel.transit_system.query.get_closest_times_in_service"><tt class="xref py py-meth docutils literal"><span class="pre">get_closest_times_in_service()</span></tt></a> is used to locate the
most likely scheduled time before or after the reported time.</p>
<p>Initial surveys of the data provided guidance on the upper bounds
for time and distance matching.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first last simple">
<li><strong>lat_lon</strong> &#8211; A (lat,lon) tuple from a <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a> instance.</li>
<li><strong>time</strong> &#8211; A time (seconds past midnight) from a <a class="reference internal" href="#caravel.report.Report" title="caravel.report.Report"><tt class="xref py py-class docutils literal"><span class="pre">caravel.report.Report</span></tt></a> instance.</li>
<li><strong>services</strong> &#8211; The iterable sequence of services applicable</li>
<li><strong>max_dist</strong> &#8211; An upper limit on distances to examine.  The default value is 0.1 mile.</li>
<li><strong>min_time</strong> &#8211; The lower limit on seconds prior to the scheduled time.
Usually, this is a negative number.  The default is about -180 seconds.</li>
<li><strong>max_time</strong> &#8211; The upper limit on seconds after the the scheduled time.
This is a positive number.  The default is about 360 seconds.</li>
</ul>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_route_from_stop_time">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_route_from_stop_time</tt><big>(</big><em>stop_time</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_route_from_stop_time"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_route_from_stop_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Query the route that contains a given stop_time value.
This does a stop_times JOIN trips JOIN routes query.</p>
<p>This is ill-constrained, since it can provide lots of
routes all over the transit system.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>stop_time</strong> &#8211; a <tt class="xref py py-class docutils literal"><span class="pre">Stop_Time</span></tt> instance.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">a <tt class="xref py py-class docutils literal"><span class="pre">Route</span></tt> instance.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_next_stop_time">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_next_stop_time</tt><big>(</big><em>stop</em>, <em>time</em>, <em>services</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_next_stop_time"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_next_stop_time" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a <tt class="xref py py-class docutils literal"><span class="pre">Stop_Definition</span></tt> object, a time after midnight,
and specific classes of service,
locate the remaining sequence of stops.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>stop</strong> &#8211; A <tt class="xref py py-class docutils literal"><span class="pre">Stop_Definition</span></tt> object</li>
<li><strong>time</strong> &#8211; A seconds-after-midnight arrival time to use as a filter</li>
<li><strong>services</strong> &#8211; The iterable sequence of services applicable</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">sequence of dictionaries with stop time information.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_route">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_route</tt><big>(</big><em>id=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_route"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_route" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns route or list of routes.</p>
<p>If <tt class="docutils literal"><span class="pre">id</span></tt> is None, it returns all route definitions.</p>
<p>Otherwise, it returns the requested route definition.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>id</strong> &#8211; Optional route id.  If no route id, all routes are returned.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">route definition or list of route definitions.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_stop">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_stop</tt><big>(</big><em>id=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_stop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns stop or list of stops.</p>
<p>If <tt class="docutils literal"><span class="pre">id</span></tt> is None, it returns all stop definitions.</p>
<p>Otherwise, it returns the requested stop definition.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><strong>id</strong> &#8211; Optional stop id.  If no stop id, all stops are returned.</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body">stop definition or list of stop definitions.</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_route_stops">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_route_stops</tt><big>(</big><em>id</em>, <em>dir=None</em>, <em>date=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_route_stops"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_route_stops" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a route with a list of stops on that route.</p>
<p>The route ID is required.
Either a direction or a date must be given to filter the stops
along the route.</p>
<p>If direction is given,</p>
<blockquote>
<div>All stops in a particular direction along the route.  The direction is
more-or-less inoound or outbound, and is actually a foreign key to a direction
table.</div></blockquote>
<p>If date is given,</p>
<blockquote>
<div>All stops along the route filtered by services available on the given date.
Day of week is generally sufficient, but there are calendar overrides,
so full date is required.</div></blockquote>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>id</strong> &#8211; route id.</li>
<li><strong>dir</strong> &#8211; optional direction, codes are &#8216;1&#8217; and &#8216;0&#8217;.</li>
<li><strong>date</strong> &#8211; a datetime.date object; the services available on this date
are used to filter the results.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">a <tt class="xref py py-class docutils literal"><span class="pre">Route_Definition</span></tt> instance.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_stop_times">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_stop_times</tt><big>(</big><em>id</em>, <em>dir=None</em>, <em>date=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_stop_times"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_stop_times" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a stop with a list of stop times.</p>
<p>The stop ID is required.
Either a direction or a date must be given to filter the times
at this stop.</p>
<p>If a direction is given.</p>
<blockquote>
<div>All stop times for this stop constrained by trip direction.</div></blockquote>
<p>If a date is given.</p>
<blockquote>
<div>All stop times for this stop constrained by services on the specific date.</div></blockquote>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>id</strong> &#8211; stop id.</li>
<li><strong>dir</strong> &#8211; optional route direction, codes are &#8216;1&#8217; and &#8216;0&#8217;.</li>
<li><strong>date</strong> &#8211; a datetime.date object; the services available on this date
are used to filter the results.</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">a <tt class="xref py py-class docutils literal"><span class="pre">Stop_Definition</span></tt> instance.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_closest_stops_filtered">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_closest_stops_filtered</tt><big>(</big><em>lat_lon</em>, <em>max_dist=None</em>, <em>dir=None</em>, <em>date=None</em>, <em>time=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_closest_stops_filtered"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_closest_stops_filtered" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a lat/lon pair, locate nearby stops.</p>
<p>Handles the following kinds of queries for a stop.</p>
<ul>
<li><p class="first">latlng=nn.nnnnnn,mm.mmmmmm and direction</p>
<p>This can find the nearest stops for all routes heading in this direction.</p>
</li>
<li><p class="first">latlng=nn.nnnnnn,mm.mmmmmm and date</p>
<p>This finds the nearest stops with a service that is active on the given date.</p>
</li>
<li><p class="first">atlng=nn.nnnnnn,mm.mmmmmm and time</p>
<p>This finds the nearest stops with a service that is active on the given date
and on or after the given time.</p>
</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>lat_lon</strong> &#8211; A (lat,lon) 2-tuple</li>
<li><strong>dir</strong> &#8211; A trip direction_id</li>
<li><strong>max_dist</strong> &#8211; An upper limit on distances to examine</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterator over (distance,stop) pairs ordered from nearest to
the specified max_dist value.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

<dl class="function">
<dt id="caravel.transit_system.query.get_closest_routes_filtered">
<tt class="descclassname">caravel.transit_system.query.</tt><tt class="descname">get_closest_routes_filtered</tt><big>(</big><em>lat_lon</em>, <em>id</em>, <em>dir=None</em>, <em>max_dist=None</em>, <em>date=None</em>, <em>time=None</em><big>)</big><a class="reference internal" href="../_modules/caravel/transit_system/query.html#get_closest_routes_filtered"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.transit_system.query.get_closest_routes_filtered" title="Permalink to this definition">¶</a></dt>
<dd><p>Given a lat/lon pair, locate nearby stops on a given route.</p>
<p>Handles the following kinds of queries for stops associated with a given route.</p>
<ul>
<li><p class="first">latlng=nn.nnnnnn,mm.mmmmmm</p>
<p>This can find the nearest stops on the given route to this coordinate.</p>
</li>
<li><p class="first">latlng=nn.nnnnnn,mm.mmmmmm and direction</p>
<p>This can find the nearest stops on the given route and direction to this coordinate.</p>
</li>
<li><p class="first">latlng=nn.nnnnnn,mm.mmmmmm, direction and date</p>
<p>This can find the nearest stops on the given route and direction to this coordinate
active on the given date.</p>
</li>
<li><p class="first">latlng=nn.nnnnnn,mm.mmmmmm, direction, date and time</p>
<p>This can find the nearest stops on the given route and direction to this coordinate
active on the given date and on or after the given time.</p>
</li>
</ul>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Parameters:</th><td class="field-body"><ul class="first simple">
<li><strong>lat_lon</strong> &#8211; A (lat,lon) 2-tuple</li>
<li><strong>dir</strong> &#8211; A trip direction_id</li>
<li><strong>max_dist</strong> &#8211; An upper limit on distances to examine</li>
</ul>
</td>
</tr>
<tr class="field-even field"><th class="field-name">Paran id:</th><td class="field-body"><p class="first">route id</p>
</td>
</tr>
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body"><p class="first last">iterator over (distance,stop) pairs ordered from nearest to
the specified max_dist value.</p>
</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
</div>
<div class="section" id="status">
<h2>Status<a class="headerlink" href="#status" title="Permalink to this headline">¶</a></h2>
<p>The final, useful status reports.</p>
<span class="target" id="module-caravel.status.status_load"></span><p>Caravel ETL of real-time-feed with mappings
from source encodings to GTFS keys.</p>
<ol class="arabic simple">
<li>Get the next position report with the mapping applied.<ul>
<li>Locations have precious little additional information.</li>
<li>Arrivals, however, have plenty of additional data, including
Route, Direction and Stop.</li>
</ul>
</li>
<li>Track route, route-stop, stop and vehicle status.</li>
<li>Clean up old status reports.</li>
</ol>
<div class="section" id="id1">
<h3>Components<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<dl class="function">
<dt id="caravel.status.status_load.update_route">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">update_route</tt><big>(</big><em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#update_route"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.update_route" title="Permalink to this definition">¶</a></dt>
<dd><p>Add to today&#8217;s route/direction documents.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.update_route_stop">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">update_route_stop</tt><big>(</big><em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#update_route_stop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.update_route_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Add to today&#8217;s route/direction/stop documents.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.update_stop">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">update_stop</tt><big>(</big><em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#update_stop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.update_stop" title="Permalink to this definition">¶</a></dt>
<dd><p>Add to today&#8217;s Stop documents.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.update_vehicle">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">update_vehicle</tt><big>(</big><em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#update_vehicle"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.update_vehicle" title="Permalink to this definition">¶</a></dt>
<dd><p>Add to today&#8217;s vehicle documents at this stop.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.track_arrival">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">track_arrival</tt><big>(</big><em>mappings</em>, <em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#track_arrival"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.track_arrival" title="Permalink to this definition">¶</a></dt>
<dd><p>Apply mappings.  Create or update status objects.</p>
<p>Use a Hard-wired mapping for direction.</p>
<p>Apply current mappings for route, vehicle and stop.
If (a) the mapping exists and (b) the value is in the mapping</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.track_location">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">track_location</tt><big>(</big><em>mappings</em>, <em>report</em><big>)</big><a class="reference internal" href="../_modules/caravel/status/status_load.html#track_location"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#caravel.status.status_load.track_location" title="Permalink to this definition">¶</a></dt>
<dd><p>Track a simple location report.</p>
</dd></dl>

<dl class="function">
<dt id="caravel.status.status_load.remove_old">
<tt class="descclassname">caravel.status.status_load.</tt><tt class="descname">remove_old</tt><big>(</big><em>db</em>, <em>today=None</em><big>)</big><a class="headerlink" href="#caravel.status.status_load.remove_old" title="Permalink to this definition">¶</a></dt>
<dd><p>Remove old Route, RouteStop and Vehicle reports.</p>
<p>This should only be run once in a great while.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Returns:</th><td class="field-body">sequence of {id:..., rev:..., ok:true} status responses.</td>
</tr>
</tbody>
</table>
</dd></dl>

</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../caravel.html">
              <img class="logo" src="../_static/Caravel2_(PSF).png" alt="Logo"/>
            </a></p>
  <h3><a href="../caravel.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Domain Model Implementation</a><ul>
<li><a class="reference internal" href="#feed">Feed</a><ul>
<li><a class="reference internal" href="#module-caravel.feed.mapping_load">Mapping Load</a><ul>
<li><a class="reference internal" href="#attachment-handling">Attachment Handling</a></li>
<li><a class="reference internal" href="#mapping-processing">Mapping Processing</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-caravel.feed.feed_load">Feed Load</a><ul>
<li><a class="reference internal" href="#components">Components</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#report">Report</a><ul>
<li><a class="reference internal" href="#report-objects">Report Objects</a></li>
<li><a class="reference internal" href="#report-factory">Report Factory</a></li>
<li><a class="reference internal" href="#json-codec">JSON Codec</a></li>
</ul>
</li>
<li><a class="reference internal" href="#transit-system">Transit System</a><ul>
<li><a class="reference internal" href="#module-caravel.transit_system.load">Transit System Load</a><ul>
<li><a class="reference internal" href="#load">Load</a></li>
</ul>
</li>
<li><a class="reference internal" href="#module-caravel.transit_system.query">Transit System Query</a><ul>
<li><a class="reference internal" href="#query-functions">Query Functions</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#status">Status</a><ul>
<li><a class="reference internal" href="#id1">Components</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="database.html"
                        title="previous chapter">Database Implementation</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="etl.html"
                        title="next chapter">Extract Transform and Load</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/implementation/domain.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="etl.html" title="Extract Transform and Load"
             >next</a> |</li>
        <li class="right" >
          <a href="database.html" title="Database Implementation"
             >previous</a> |</li>
        <li><a href="../caravel.html">Caravel-Transit 1.2 documentation</a> &raquo;</li>
          <li><a href="index.html" >Implementation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, S.Lott.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.2.
    </div>
  </body>
</html>